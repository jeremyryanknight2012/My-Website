<!DOCTYPE html>
<html lang="en-us">
<head>
  <base href="https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/">
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Unity WebGL Player | Cuphead</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #231F20;
    }
    #unityContainer {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #231F20;
    }
    #loading-text {
      position: fixed;
      left: 0; right: 0;
      top: 20px;
      text-align: center;
      color: #fff;
      font-size: 48px;
      font-family: cursive;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="loading-text">LOADING...</div>
  <div id="unityContainer"></div>

  <script src="Build/UnityLoader.js"></script>
  <script>
    const loadingText = document.querySelector("#loading-text");
    const container = document.getElementById("unityContainer");

    let totalBytes = 0;
    let loadedBytes = 0;

    function bytesToMB(b) {
      return (b / (1024 * 1024)).toFixed(2);
    }

    async function getSize(url) {
      try {
        const res = await fetch(url, { method: "HEAD" });
        return parseInt(res.headers.get("Content-Length") || "0", 10);
      } catch {
        return 0;
      }
    }

    async function fetchWithProgress(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Fetch failed (${response.status}) for ${url}`);
      if (!response.body) throw new Error(`No readable stream for ${url}`);

      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        received += value.length;
        loadedBytes += value.length;
        chunks.push(value);

        const mbDone = bytesToMB(loadedBytes);
        const mbTotal = totalBytes > 0 ? bytesToMB(totalBytes) : "???";
        loadingText.textContent = `LOADING... ${mbDone} MB / ${mbTotal} MB`;
      }

      const fullBuffer = new Uint8Array(received);
      let offset = 0;
      for (const chunk of chunks) {
        fullBuffer.set(chunk, offset);
        offset += chunk.length;
      }
      return fullBuffer.buffer;
    }

    async function mergeFiles(fileParts) {
      const buffers = await Promise.all(fileParts.map(part => fetchWithProgress(part)));
      const mergedBlob = new Blob(buffers);
      return URL.createObjectURL(mergedBlob);
    }

    function getParts(file, start, end) {
      const parts = [];
      for (let i = start; i <= end; i++) parts.push(file + ".part" + i);
      return parts;
    }

    function resizeUnityContainer() {
      container.style.width = window.innerWidth + "px";
      container.style.height = window.innerHeight + "px";
    }

    window.addEventListener("resize", resizeUnityContainer);

    (async () => {
      try {
        if (typeof UnityLoader === "undefined") {
          throw new Error("UnityLoader is not defined. Make sure Build/UnityLoader.js exists and loads.");
        }

        // List all parts to calculate total size (best-effort; HEAD may return 0 depending on CDN)
        const allParts = [
          ...getParts("Build/Build.asm.code.unityweb", 1, 3),
          ...getParts("Build/Build.data.unityweb", 1, 102),
          ...getParts("Build/Build.wasm.code.unityweb", 1, 2),
        ];

        const sizes = await Promise.all(allParts.map(getSize));
        totalBytes = sizes.reduce((a, b) => a + b, 0);

        // Merge part files into blob URLs
        const [asmUrl, dataUrl, wasmUrl] = await Promise.all([
          mergeFiles(getParts("Build/Build.asm.code.unityweb", 1, 3)),
          mergeFiles(getParts("Build/Build.data.unityweb", 1, 102)),
          mergeFiles(getParts("Build/Build.wasm.code.unityweb", 1, 2)),
        ]);

        // UnityLoader expects a URL to the json config.
        // We generate that config dynamically, pointing to our blob URLs.
        const config = {
          companyName: "SpanishFreddy",
          productName: "Cuphead",

          // Important: these are URLs UnityLoader will fetch.
          dataUrl: dataUrl,
          wasmCodeUrl: wasmUrl,
          asmCodeUrl: asmUrl,

          // FIXED: these paths should include "Build/"
          wasmFrameworkUrl: "Build/Build.wasm.framework.unityweb",
          asmMemoryUrl: "Build/Build.asm.memory.unityweb",
          asmFrameworkUrl: "Build/Build.asm.framework.unityweb",

          TOTAL_MEMORY: 100000000,
          graphicsAPI: ["WebGL 2.0"],
          webglContextAttributes: { preserveDrawingBuffer: false },
          splashScreenStyle: "Dark",
          backgroundColor: "#231F20"
        };

        const blob = new Blob([JSON.stringify(config)], { type: "application/json" });
        const blobUrl = URL.createObjectURL(blob);

        resizeUnityContainer();

        // âœ… FIX: pass blobUrl (string) as the second argument
        UnityLoader.instantiate("unityContainer", blobUrl, {
          Module: {
            onRuntimeInitialized: function () {
              resizeUnityContainer();
              if (loadingText) loadingText.remove();
            }
          }
          // You can also add onProgress here if you want Unity's internal progress bar.
          // onProgress: function (unityInstance, progress) { ... }
        });

      } catch (err) {
        console.error(err);
        loadingText.textContent = "FAILED TO LOAD (check console)";
      }
    })();
  </script>
</body>
</html>
