<!DOCTYPE html>
<html lang="en-us">
<head>
  <base href="https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/">
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | Cuphead</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #231F20;
    }

    #unityContainer {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #231F20;
    }

    #loading-text {
      position: fixed;
      left: 0;
      right: 0;
      top: 20px;
      text-align: center;
      color: white;
      font-size: 48px;
      font-family: cursive;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="loading-text">LOADING...</div>
  <div id="unityContainer"></div>

  <script src="Build/UnityLoader.js"></script>
  <script>
    const loadingText = document.getElementById("loading-text");
    const container = document.getElementById("unityContainer");

    let totalBytes = 0;
    let loadedBytes = 0;

    function bytesToMB(bytes) {
      return (bytes / (1024 * 1024)).toFixed(2);
    }

    async function getSize(url) {
      try {
        const res = await fetch(url, { method: "HEAD" });
        const len = res.headers.get("Content-Length");
        return len ? parseInt(len, 10) : 0;
      } catch {
        return 0;
      }
    }

    async function fetchWithProgress(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch ${url}`);
      if (!response.body) throw new Error(`No stream for ${url}`);

      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        received += value.length;
        loadedBytes += value.length;
        chunks.push(value);

        // ðŸ”’ HARD FIX: never allow total < loaded
        if (!totalBytes || totalBytes < loadedBytes) {
          totalBytes = loadedBytes;
        }

        const doneMB = bytesToMB(loadedBytes);
        const totalMB = bytesToMB(totalBytes);
        loadingText.textContent = `LOADING... ${doneMB} MB / ${totalMB} MB`;
      }

      const buffer = new Uint8Array(received);
      let offset = 0;
      for (const chunk of chunks) {
        buffer.set(chunk, offset);
        offset += chunk.length;
      }
      return buffer.buffer;
    }

    async function mergeFiles(parts) {
      const buffers = await Promise.all(parts.map(fetchWithProgress));
      return URL.createObjectURL(new Blob(buffers));
    }

    function getParts(file, start, end) {
      const out = [];
      for (let i = start; i <= end; i++) {
        out.push(`${file}.part${i}`);
      }
      return out;
    }

    function resize() {
      container.style.width = window.innerWidth + "px";
      container.style.height = window.innerHeight + "px";
    }

    window.addEventListener("resize", resize);

    (async () => {
      try {
        if (typeof UnityLoader === "undefined") {
          throw new Error("UnityLoader.js failed to load");
        }

        const allParts = [
          ...getParts("Build/Build.asm.code.unityweb", 1, 3),
          ...getParts("Build/Build.data.unityweb", 1, 102),
          ...getParts("Build/Build.wasm.code.unityweb", 1, 2),
        ];

        // Best-effort size calculation
        const sizes = await Promise.all(allParts.map(getSize));
        totalBytes = sizes.reduce((a, b) => a + b, 0);

        const [asmUrl, dataUrl, wasmUrl] = await Promise.all([
          mergeFiles(getParts("Build/Build.asm.code.unityweb", 1, 3)),
          mergeFiles(getParts("Build/Build.data.unityweb", 1, 102)),
          mergeFiles(getParts("Build/Build.wasm.code.unityweb", 1, 2)),
        ]);

        const config = {
          companyName: "SpanishFreddy",
          productName: "Cuphead",

          dataUrl: dataUrl,
          wasmCodeUrl: wasmUrl,
          asmCodeUrl: asmUrl,

          wasmFrameworkUrl: "Build/Build.wasm.framework.unityweb",
          asmMemoryUrl: "Build/Build.asm.memory.unityweb",
          asmFrameworkUrl: "Build/Build.asm.framework.unityweb",

          TOTAL_MEMORY: 100000000,
          graphicsAPI: ["WebGL 2.0"],
          webglContextAttributes: { preserveDrawingBuffer: false },
          splashScreenStyle: "Dark",
          backgroundColor: "#231F20"
        };

        const jsonBlob = new Blob([JSON.stringify(config)], { type: "application/json" });
        const jsonURL = URL.createObjectURL(jsonBlob);

        resize();

        UnityLoader.instantiate("unityContainer", jsonURL, {
          Module: {
            onRuntimeInitialized() {
              resize();
              loadingText.remove();
            }
          }
        });

      } catch (err) {
        console.error(err);
        loadingText.textContent = "FAILED TO LOAD (check console)";
      }
    })();
  </script>
</body>
</html>
