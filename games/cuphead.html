<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | Cuphead</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      overflow: hidden;
      background: #231F20;
    }
    #unityContainer {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #231F20;
    }
    #loading-text {
      position: fixed;
      left: 0; right: 0;
      top: 20px;
      text-align: center;
      color: white;
      font-size: 36px;
      font-family: cursive;
      z-index: 9999;
      padding: 0 16px;
      word-break: break-word;
    }
    #loading-text small {
      display: block;
      margin-top: 10px;
      font-size: 16px;
      font-family: monospace;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div id="loading-text">LOADING...</div>
  <div id="unityContainer"></div>

  <!-- Use absolute URL instead of <base>, to avoid weird path side-effects -->
  <script src="https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/Build/UnityLoader.js"></script>

  <script>
    const CDN = "https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/";
    const loadingText = document.getElementById("loading-text");
    const container = document.getElementById("unityContainer");

    let totalBytes = 0;
    let loadedBytes = 0;

    function bytesToMB(bytes) {
      return (bytes / (1024 * 1024)).toFixed(2);
    }

    function setStatus(main, detail = "") {
      loadingText.innerHTML = `${main}${detail ? `<small>${detail}</small>` : ""}`;
    }

    async function getSize(url) {
      // HEAD often fails/403 on some CDNs; treat as best-effort.
      try {
        const res = await fetch(url, { method: "HEAD" });
        if (!res.ok) return 0;
        const len = res.headers.get("Content-Length");
        return len ? parseInt(len, 10) : 0;
      } catch {
        return 0;
      }
    }

    async function fetchWithProgress(url) {
      const response = await fetch(url);

      // ✅ CRITICAL: stop if blocked/missing so we don’t merge HTML error pages
      if (!response.ok) {
        throw new Error(`HTTP ${response.status} for ${url}`);
      }
      if (!response.body) {
        throw new Error(`No readable stream for ${url}`);
      }

      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        received += value.length;
        loadedBytes += value.length;
        chunks.push(value);

        // Fix “100/10” overflow: total must never be less than loaded.
        if (!totalBytes || totalBytes < loadedBytes) totalBytes = loadedBytes;

        setStatus(
          `LOADING... ${bytesToMB(loadedBytes)} MB / ${bytesToMB(totalBytes)} MB`
        );
      }

      const buffer = new Uint8Array(received);
      let offset = 0;
      for (const chunk of chunks) {
        buffer.set(chunk, offset);
        offset += chunk.length;
      }
      return buffer.buffer;
    }

    // Unity often checks ".unityweb" to decide decompression.
    function makeUnitywebBlobUrl(blob) {
      return URL.createObjectURL(blob) + "#.unityweb";
    }

    async function mergeFiles(urls) {
      const buffers = await Promise.all(urls.map(fetchWithProgress));
      const mergedBlob = new Blob(buffers, { type: "application/octet-stream" });
      return makeUnitywebBlobUrl(mergedBlob);
    }

    function getParts(path, start, end) {
      const urls = [];
      for (let i = start; i <= end; i++) {
        urls.push(CDN + path + ".part" + i);
      }
      return urls;
    }

    function resize() {
      container.style.width = window.innerWidth + "px";
      container.style.height = window.innerHeight + "px";
      const canvas = container.querySelector("canvas");
      if (canvas) {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
      }
    }
    window.addEventListener("resize", resize);

    (async () => {
      try {
        if (typeof UnityLoader === "undefined") {
          throw new Error("UnityLoader failed to load.");
        }

        const allParts = [
          ...getParts("Build/Build.asm.code.unityweb", 1, 3),
          ...getParts("Build/Build.data.unityweb", 1, 102),
          ...getParts("Build/Build.wasm.code.unityweb", 1, 2),
        ];

        // Best-effort “total” (may be 0 if HEAD blocked). We clamp during download anyway.
        const sizes = await Promise.all(allParts.map(getSize));
        totalBytes = sizes.reduce((a, b) => a + b, 0);

        // Merge
        const [asmUrl, dataUrl, wasmUrl] = await Promise.all([
          mergeFiles(getParts("Build/Build.asm.code.unityweb", 1, 3)),
          mergeFiles(getParts("Build/Build.data.unityweb", 1, 102)),
          mergeFiles(getParts("Build/Build.wasm.code.unityweb", 1, 2)),
        ]);

        // Config (framework/memory paths must be correct)
        const config = {
          companyName: "SpanishFreddy",
          productName: "Cuphead",

          dataUrl: dataUrl,
          wasmCodeUrl: wasmUrl,
          asmCodeUrl: asmUrl,

          wasmFrameworkUrl: CDN + "Build/Build.wasm.framework.unityweb",
          asmMemoryUrl: CDN + "Build/Build.asm.memory.unityweb",
          asmFrameworkUrl: CDN + "Build/Build.asm.framework.unityweb",

          TOTAL_MEMORY: 100000000,
          graphicsAPI: ["WebGL 2.0", "WebGL 1.0"],
          webglContextAttributes: { preserveDrawingBuffer: false },
          splashScreenStyle: "Dark",
          backgroundColor: "#231F20"
        };

        // Old UnityLoader supports: UnityLoader.instantiate(containerId, configObject)
        resize();
        UnityLoader.instantiate("unityContainer", config, {
          Module: {
            onRuntimeInitialized() {
              resize();
              loadingText.remove();
            }
          }
        });

      } catch (err) {
        console.error(err);

        // ✅ Show the exact failing URL / status (this is what you need to fix next)
        setStatus(
          "FAILED TO LOAD",
          String(err.message || err)
        );
      }
    })();
  </script>
</body>
</html>
