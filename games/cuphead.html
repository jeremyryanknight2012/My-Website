<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <title>Unity WebGL Player | Cuphead</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      overflow: hidden;
      background: #231F20;
    }
    #unityContainer {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #231F20;
    }
    #loading-text {
      position: fixed;
      left: 0; right: 0;
      top: 20px;
      text-align: center;
      color: #fff;
      font-size: 36px;
      font-family: cursive;
      z-index: 9999;
      padding: 0 16px;
      word-break: break-word;
    }
    #loading-text small {
      display: block;
      margin-top: 10px;
      font-size: 14px;
      font-family: monospace;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div id="loading-text">LOADING...</div>
  <div id="unityContainer"></div>

  <script src="https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/Build/UnityLoader.js"></script>

  <script>
    const CDN = "https://cdn.jsdelivr.net/gh/web-ports/cuphead@main/";
    const loadingText = document.getElementById("loading-text");
    const container = document.getElementById("unityContainer");

    let totalBytes = 0;
    let loadedBytes = 0;

    function bytesToMB(bytes) {
      return (bytes / (1024 * 1024)).toFixed(2);
    }

    function setStatus(main, detail = "") {
      loadingText.innerHTML = `${main}${detail ? `<small>${detail}</small>` : ""}`;
    }

    async function fetchWithProgress(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status} for ${url}`);
      if (!response.body) throw new Error(`No stream for ${url}`);

      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        received += value.length;
        loadedBytes += value.length;
        chunks.push(value);

        if (!totalBytes || totalBytes < loadedBytes) totalBytes = loadedBytes;
        setStatus(`LOADING... ${bytesToMB(loadedBytes)} MB / ${bytesToMB(totalBytes)} MB`);
      }

      const buffer = new Uint8Array(received);
      let offset = 0;
      for (const chunk of chunks) {
        buffer.set(chunk, offset);
        offset += chunk.length;
      }
      return buffer.buffer;
    }

    // Unity loaders often detect ".unityweb" to decide decompression.
    function unitywebBlobUrl(blob) {
      return URL.createObjectURL(blob) + "#.unityweb";
    }

    async function mergeFiles(urls) {
      const buffers = await Promise.all(urls.map(fetchWithProgress));
      const mergedBlob = new Blob(buffers, { type: "application/octet-stream" });
      return unitywebBlobUrl(mergedBlob);
    }

    function getParts(path, start, end) {
      const urls = [];
      for (let i = start; i <= end; i++) {
        urls.push(CDN + path + ".part" + i);
      }
      return urls;
    }

    function resize() {
      container.style.width = window.innerWidth + "px";
      container.style.height = window.innerHeight + "px";
      const canvas = container.querySelector("canvas");
      if (canvas) {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
      }
    }
    window.addEventListener("resize", resize);

    (async () => {
      try {
        if (typeof UnityLoader === "undefined") {
          throw new Error("UnityLoader failed to load.");
        }

        // Merge the split files into blob URLs
        const [asmUrl, dataUrl, wasmUrl] = await Promise.all([
          mergeFiles(getParts("Build/Build.asm.code.unityweb", 1, 3)),
          mergeFiles(getParts("Build/Build.data.unityweb", 1, 102)),
          mergeFiles(getParts("Build/Build.wasm.code.unityweb", 1, 2)),
        ]);

        // ✅ Create a REAL config JSON file and pass its URL to UnityLoader as arg #2
        const config = {
          companyName: "SpanishFreddy",
          productName: "Cuphead",

          dataUrl: dataUrl,
          wasmCodeUrl: wasmUrl,
          asmCodeUrl: asmUrl,

          // NOTE: These are NOT split, so load them directly from CDN:
          wasmFrameworkUrl: CDN + "Build/Build.wasm.framework.unityweb",
          asmMemoryUrl: CDN + "Build/Build.asm.memory.unityweb",
          asmFrameworkUrl: CDN + "Build/Build.asm.framework.unityweb",

          TOTAL_MEMORY: 100000000,
          graphicsAPI: ["WebGL 2.0", "WebGL 1.0"],
          webglContextAttributes: { preserveDrawingBuffer: false },
          splashScreenStyle: "Dark",
          backgroundColor: "#231F20"
        };

        const configBlob = new Blob([JSON.stringify(config)], { type: "application/json" });
        const configUrl = URL.createObjectURL(configBlob);

        resize();

        // ✅ THIS is the important part: pass configUrl (string), not HTML, not object w/ url
        UnityLoader.instantiate("unityContainer", configUrl, {
          Module: {
            onRuntimeInitialized() {
              resize();
              loadingText.remove();
            }
          }
        });

      } catch (err) {
        console.error(err);
        setStatus("FAILED TO LOAD", err.message || String(err));
      }
    })();
  </script>
</body>
</html>
