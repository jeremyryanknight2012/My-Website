<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SME Launcher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        @font-face {
            font-family: "Comic Sans MS";
            src: local("Comic Sans MS");
        }

        :root {
            --bg: #0f0f0f;
            --bg2: #1a1a1a;
            --text: #fff;
            --accent: #4caf50;
            --sidebar: #000;
            --banner1: #000;
            --banner2: #0f0f0f;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Comic Sans MS";
            overflow-x: hidden;
        }

        body.light {
            --bg: #f5f5f5;
            --bg2: #ffffff;
            --text: #111;
            --accent: #2196f3;
            --sidebar: #222;
        }

        /* SIDEBAR */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 75px;
            height: 100%;
            background: var(--sidebar);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        #sidebar div {
            padding: 15px;
            cursor: pointer;
            text-align: center;
            font-size: 24px;
            transition: 0.2s;
        }

        #sidebar div:hover {
            transform: scale(1.2);
        }

        /* MAIN */
        #main {
            margin-left: 90px;
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        #homeDashboard {
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }

        .homeCard {
            background: var(--bg2);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px #0005;
        }

        .postBox {
            background: #222;
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
        }

        body.light .postBox {
            background: #ddd;
        }

        .postAuthor {
            font-weight: bold;
            color: var(--accent);
        }

        .postTime {
            opacity: 0.6;
            font-size: 11px;
        }

        .postActions {
            margin-top: 5px;
            font-size: 13px;
            opacity: 0.8;
            display: flex;
            gap: 15px;
        }

        /* GAME CARDS */
        .card {
            background: var(--bg2);
            width: 260px;
            height: 380px;
            border-radius: 12px;
            padding: 12px;
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            margin: 8px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            vertical-align: top;
        }

        .card:hover {
            transform: translateY(-6px) scale(1.05);
        }

        .card img {
            width: 100%;
            height: auto;
            max-height: 260px;
            /* keeps them from getting too tall */
            object-fit: contain;
            /* shows full PNG without cropping */
            border-radius: 10px;
            display: block;
        }

        .star {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }

        .star.fav {
            color: gold;
            text-shadow: 0 0 10px gold;
        }

        #embedWin {
            display: none;
            position: fixed;
            inset: 0;
            background: #000d;
            z-index: 9999;
        }

        #embedFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .profileBanner {
            width: 100%;
            height: 90px;
            background: linear-gradient(90deg, var(--accent), transparent);
            border-radius: 12px;
        }

        .profileAvatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            border: 3px solid var(--bg2);
            margin-top: -48px;
            margin-left: 15px;
            background: #333;
            background-size: cover; /* Added for friend modal */
        }

        .tabBtn {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #222;
            color: var(--text);
            cursor: pointer;
        }

        .tabBtn:hover {
            background: var(--accent);
        }

        #settingsContent {
            background: var(--bg2);
            padding: 15px;
            border-radius: 10px;
        }

        .sme-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 0 10px #000;
            font-size: 14px;
            opacity: 0;
            transition: 0.25s;
            z-index: 10000;
        }

        .sme-toast.success {
            background: #2e7d32;
        }

        .sme-toast.info {
            background: #1976d2;
        }

        .sme-toast.error {
            background: #c62828;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #homeBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 55px;
            height: 55px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            cursor: pointer;
            z-index: 5000;
            box-shadow: 0 0 10px #0008;
            transition: 0.2s;
        }

        #homeBtn:hover {
            transform: scale(1.15);
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div onclick="nav('homeDashboard')">üè†</div>
        <div onclick="nav('games')">üéÆ</div>
        <div onclick="nav('downloads')">‚¨á</div>
        <div onclick="nav('favorites')">‚≠ê</div>
        <div onclick="nav('theater')">üé¨</div>
        <div onclick="nav('friends')">üë•</div>
        <div onclick="nav('profile')">üë§</div>
        <div onclick="openSettings()">‚öôÔ∏è</div>
        <div onclick="toggleTheme()">üåó</div>
        <div onclick="panic()">‚ö†</div>
    </div>

    <div id="homeBtn" onclick="goHome()">üè†</div>

    <div id="main">
        <h1 id="pageTitle">Home</h1>

        <div id="homeDashboard" class="section active">
            <div class="homeCard">
                <h2>Welcome back!</h2>
                <p>To exit a game refresh the page or click esc</p>
            </div>

            <div id="continuePlaying" class="homeCard">
                <h3>Continue Playing</h3>
                <div id="continueList"></div>
            </div>

            <div id="socialFeed" class="homeCard">
                <h3>Social Feed</h3>
                <div id="feedPosts"></div>
                <textarea
                    id="feedInput"
                    placeholder="Share something..."
                    style="width:100%;height:60px;padding:10px;border:none;border-radius:8px;background:#222;color:white;margin-top:10px;"
                ></textarea>
                <button
                    onclick="postToFeed()"
                    style="padding:10px;margin-top:8px;width:100%;border:none;border-radius:8px;background:var(--accent);color:white;"
                >
                    Post
                </button>
            </div>

            <div id="friendsOnline" class="homeCard">
                <h3>Friends Online</h3>
                <div id="onlineList"></div>
            </div>

            <div id="activityLog" class="homeCard">
                <h3>Recent Activity</h3>
                <div id="activityList"></div>
            </div>
        </div>

        <div id="games" class="section"></div>
        <div id="downloads" class="section"></div>
        <div id="favorites" class="section"></div>
        <div id="theater" class="section"></div>

        <div id="friends" class="section">
            <h2>Friends & Messages</h2>

            <div class="homeCard">
                <h3>Your Friend Code</h3>
                <p>Share this code to be added by others. Your ID is needed to send friend requests.</p>
                <code id="displayFriendCode" style="font-size:1.2em; color:var(--accent);">Loading...</code>
                <button onclick="copyFriendCode()" class="tabBtn" style="margin-left:10px;">Copy Code</button>
                <div id="authStatus" style="margin-top:10px; font-size:12px; color:red;">Not Logged In. Cannot use online features.</div>
            </div>

            <div class="homeCard">
                <h3>Send Friend Request</h3>
                <input type="text" id="friendCodeInput" placeholder="Enter Friend Code (e.g., SME-A1B2C3)"
                    style="padding:10px; width:200px; border-radius:8px; border:1px solid #444; background:var(--bg); color:var(--text);"
                >
                <button onclick="sendFriendRequest()" class="tabBtn">Send Request</button>
            </div>
            
            <div class="homeCard">
                <h3>Pending Requests (<span id="requestCount">0</span>)</h3>
                <div id="requestsList">
                    </div>
            </div>

            <div class="homeCard">
                <h3>My Friends (<span id="friendCount">0</span>)</h3>
                <div id="friendListContainer">
                    </div>
            </div>

            <div id="chatWindow" class="homeCard" style="display:none;">
                <h3 id="chatRecipient">Chat with [Friend Name]</h3>
                <div id="messagesContainer" style="height:300px; overflow-y:scroll; background:var(--bg); padding:10px; border-radius:8px; margin-bottom:10px;">
                    </div>
                <input type="text" id="messageInput" placeholder="Type a message..."
                    style="padding:10px; width:calc(100% - 70px); border-radius:8px; border:1px solid #444; background:var(--bg); color:var(--text);"
                >
                <button onclick="sendMessage()" class="tabBtn" style="width:60px;">Send</button>
            </div>
        </div>
        
        <div id="profile" class="section"></div>
        <div id="settingsPage" class="section">
            <div id="settingsContent"></div>
        </div>
    </div>

    <div id="embedWin">
        <iframe id="embedFrame"></iframe>
    </div>

    <div
        id="gameModal"
        style="
            display:none;
            position:fixed;
            inset:0;
            background:#000a;
            z-index:9999;
            align-items:center;
            justify-content:center;
        "
    >
        <div
            id="modalBox"
            style="
                width:420px;
                background:var(--bg2);
                padding:20px;
                border-radius:15px;
                box-shadow:0 0 20px #000;
                color:white;
            "
        >
            <img id="modalImg" src="" style="width:100%;border-radius:10px;" />
            <h2 id="modalTitle"></h2>
            <p id="modalDesc"></p>
            <div id="playtimeBox" style="margin-top:10px;"></div>

            <button
                id="playBtn"
                style="
                    padding:10px;
                    width:100%;
                    border:none;
                    border-radius:8px;
                    background:var(--accent);
                    color:white;
                    margin-top:10px;
                "
            >
                Play
            </button>

            <button
                onclick="closeGameModal()"
                style="
                    padding:10px;
                    width:100%;
                    border:none;
                    border-radius:8px;
                    background:#333;
                    color:white;
                    margin-top:10px;
                "
            >
                Close
            </button>
        </div>
    </div>

    <div id="friendProfileModal" style="display:none; position:fixed; inset:0; background:#000c; z-index:9999; align-items:center; justify-content:center;">
        <div style="width:350px; background:var(--bg2); padding:20px; border-radius:15px; box-shadow:0 0 20px #000; color:var(--text);">
            <button onclick="closeFriendProfileModal()" style="float:right; background:none; border:none; color:var(--text); font-size:1.5em; cursor:pointer;">&times;</button>
            <div class="profileBanner" style="height:60px;"></div>
            <div id="modalFriendAvatar" class="profileAvatar" style="margin-top:-30px; background-size:cover;"></div>
            <h2 id="modalFriendUsername" style="margin-top:10px;"></h2>
            <p id="modalFriendStatus" style="color:var(--accent);">Online</p>
            <p id="modalFriendBio" style="margin-top:10px; opacity:0.8;"></p>
            <button id="modalMessageBtn" onclick="openChatFromProfile()" class="tabBtn" style="margin-top:15px; width:100%;">Message</button>
        </div>
    </div>
    <script type="module">
        /* ============================
               GLOBAL FIREBASE INIT (UPDATED FOR V12 MODULES)
        ============================ */

        // 1. New Imports (MUST use the type="module" script)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, where, limit, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // 2. >>> YOUR FIREBASE CONFIGURATION (PASTED FROM CONSOLE) <<<
        const firebaseConfig = {
            apiKey: "AIzaSyBxXsXA1aoOLzDD-yNaZnHETgxPAJ-mbjw",
            authDomain: "sme-loader.firebaseapp.com",
            databaseURL: "https://sme-loader-default-rtdb.firebaseio.com",
            projectId: "sme-loader",
            storageBucket: "sme-loader.firebasestorage.app",
            messagingSenderId: "427113600756",
            appId: "1:427113600756:web:73227a309d4a2e6c51b0a1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let friendCode = localStorage.getItem("friendCode");

        // 3. Setup Authentication Listener (Crucial for identifying the user)
        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                currentUserId = user.uid;
                
                // Ensure user profile exists in Firestore and set friendCode
                await setDoc(doc(db, "users", currentUserId), { 
                    username: profile.username || `User-${currentUserId.substring(0, 4)}`,
                    friendCode: friendCode,
                    avatar: profile.avatar,
                    status: profile.status,
                    lastOnline: serverTimestamp(),
                    bio: profile.bio || "A new SME Launcher user."
                }, { merge: true });
                
                document.getElementById("authStatus").textContent = `Logged in as: ${user.email || 'Anonymous'}`;
                document.getElementById("authStatus").style.color = 'lime';
                document.getElementById("displayFriendCode").textContent = friendCode;

                // Start listeners for friends and requests
                setupFriendsListener();
                setupRequestsListener();

            } else {
                currentUserId = null;
                document.getElementById("authStatus").textContent = 'Not Logged In. Cannot use online features.';
                document.getElementById("authStatus").style.color = 'red';
                document.getElementById("displayFriendCode").textContent = 'N/A';
                
                // Implement anonymous login to give the user a unique ID/FriendCode
                try {
                    const anonUserCredential = await signInAnonymously(auth); 
                    console.log("Signed in anonymously:", anonUserCredential.user.uid);
                    // Generate friendCode based on user ID if not present
                    if (!friendCode) {
                        friendCode =
                            "SME-" +
                            anonUserCredential.user.uid.substring(0, 6).toUpperCase();
                        localStorage.setItem("friendCode", friendCode);
                    }
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                    notify("Failed to connect to online services.", "error");
                }
            }
        });


        /* ============================
               GLOBAL NAV + BASICS
        ============================ */

        function nav(id) {
            document.querySelectorAll(".section").forEach((s) =>
                s.classList.remove("active")
            );
            const target = document.getElementById(id);
            if (target) target.classList.add("active");

            const titleMap = {
                homeDashboard: "Home",
                games: "Games Library",
                downloads: "SME Downloads",
                favorites: "Favorites",
                theater: "Theater",
                friends: "Friends & Messaging", 
                profile: "Profile",
                settingsPage: "Settings",
            };

            document.getElementById("pageTitle").textContent =
                titleMap[id] || "SME";

            if (id === "theater") loadTheater();
            if (id === "games") renderGames();
            if (id === "favorites") renderFavorites();
            if (id === "profile") renderProfile();
            if (id === "settingsPage") renderSettings();
            
            if (id === "friends") {
                renderFriendsPage(); // Trigger render, listeners handle updates
                closeChatWindow();
            }
        }

        function goHome() {
            nav('homeDashboard');
        }

        function toggleTheme() {
            document.body.classList.toggle("light");
        }

        function panic() {
            location.href = "https://classroom.google.com";
        }

        function enc(u) {
            return u;
        }

        function notify(msg, type = "info") {
            const t = document.createElement("div");
            t.className = "sme-toast " + type;
            t.textContent = msg;
            document.body.appendChild(t);
            requestAnimationFrame(() => {
                t.style.opacity = 1;
            });
            setTimeout(() => {
                t.style.opacity = 0;
                setTimeout(() => t.remove(), 250);
            }, 2500);
        }
        
        /* ============================
               FIREBASE FRIENDS SYSTEM (Updated with V12 Functions)
        ============================ */

        let friends = []; 
        let requests = []; 
        let currentChat = null; 
        let messageUnsubscribe = null; 
        let friendsUnsubscribe = null;
        let requestsUnsubscribe = null;

        // --- FRIENDS LISTENERS ---
        function setupFriendsListener() {
            if (!currentUserId) return;
            if (friendsUnsubscribe) friendsUnsubscribe();

            friendsUnsubscribe = onSnapshot(collection(db, "users", currentUserId, "friends"), 
                async (snapshot) => {
                    const friendIDs = snapshot.docs.map(doc => doc.id);
                    friends = [];
                    document.getElementById("friendCount").textContent = friendIDs.length;

                    if (friendIDs.length > 0) {
                        // Fetch details for all friends
                        const friendDetailsPromises = friendIDs.map(id => 
                            getDocs(doc(db, "users", id)).then(docSnap => ({ id: docSnap.id, ...docSnap.data() }))
                        );
                        
                        friends = (await Promise.all(friendDetailsPromises)).filter(f => f.friendCode);
                    }
                    renderFriendsPage();
                    renderFriendsOnline(); // Update Home section
                }, error => console.error("Error setting up friends listener:", error)
            );
        }

        function setupRequestsListener() {
            if (!currentUserId) return;
            if (requestsUnsubscribe) requestsUnsubscribe();

            requestsUnsubscribe = onSnapshot(collection(db, "users", currentUserId, "requests"),
                async (snapshot) => {
                    requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    document.getElementById("requestCount").textContent = requests.length;
                    renderRequestsList();
                }, error => console.error("Error setting up requests listener:", error)
            );
        }


        // --- FRIEND REQUESTS & ACTIONS ---
        async function sendFriendRequest() {
            if (!currentUserId) { notify("Please wait for login or check online status.", "error"); return; }
            
            const input = document.getElementById("friendCodeInput");
            const targetCode = input.value.trim().toUpperCase();
            if (targetCode === friendCode) { notify("You cannot add yourself.", "error"); return; }
            if (!targetCode || !targetCode.startsWith("SME-")) { notify("Invalid Friend Code format (e.g., SME-A1B2C3).", "error"); return; }

            // 1. Find the target user by their Friend Code
            const targetQuery = query(collection(db, "users"), where("friendCode", "==", targetCode), limit(1));
            const targetQuerySnapshot = await getDocs(targetQuery);

            if (targetQuerySnapshot.empty) {
                notify("User not found with that code.", "error");
                return;
            }
            
            const targetUserDoc = targetQuerySnapshot.docs[0];
            const targetUserId = targetUserDoc.id;
            const targetUserData = targetUserDoc.data();

            // Check if already friends
            const isFriend = await getDocs(doc(db, "users", currentUserId, "friends", targetUserId));
            if (isFriend.exists) {
                 notify(`You are already friends with ${targetUserData.username}.`, "info");
                 return;
            }

            // 2. Check if request already sent
             const isPending = await getDocs(doc(db, "users", targetUserId, "requests", currentUserId));
             if (isPending.exists) {
                 notify(`Request already pending for ${targetUserData.username}.`, "info");
                 return;
             }

            // 3. Send the request to the target user's 'requests' subcollection
            await setDoc(doc(db, "users", targetUserId, "requests", currentUserId), {
                senderCode: friendCode,
                senderUsername: profile.username || `User-${friendCode.split('-')[1]}`,
                timestamp: serverTimestamp()
            });

            input.value = "";
            notify(`Request sent to ${targetUserData.username}!`, "success");
        }
        
        async function acceptRequest(senderId) {
            if (!currentUserId) return;

            // 1. Add sender to current user's friends list
            await setDoc(doc(db, "users", currentUserId, "friends", senderId), {});
            
            // 2. Add current user to sender's friends list
            await setDoc(doc(db, "users", senderId, "friends", currentUserId), {});
            
            // 3. Remove the request from current user's requests list
            await deleteDoc(doc(db, "users", currentUserId, "requests", senderId));

            notify("Friend request accepted!", "success");
        }

        async function rejectRequest(senderId) {
            if (!currentUserId) return;
            
            await deleteDoc(doc(db, "users", currentUserId, "requests", senderId));
            notify("Friend request declined.", "info");
        }


        // --- RENDERING ---
        function renderRequestsList() {
            const list = document.getElementById("requestsList");
            list.innerHTML = "";

            if (requests.length === 0) {
                list.innerHTML = "<p>No pending friend requests.</p>";
                return;
            }

            requests.forEach(req => {
                const reqDiv = document.createElement('div');
                reqDiv.style.cssText = `
                    display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg);
                    border-radius: 8px; margin-bottom: 8px;
                `;
                reqDiv.innerHTML = `
                    <div>
                        <strong style="color:var(--accent);">${req.senderUsername}</strong>
                        <div style="font-size:12px; opacity:0.6;">Code: ${req.senderCode}</div>
                    </div>
                    <div>
                        <button onclick="acceptRequest('${req.id}')" class="tabBtn" style="background:#4caf50; margin-right:5px;">Accept</button>
                        <button onclick="rejectRequest('${req.id}')" class="tabBtn" style="background:#c62828;">Reject</button>
                    </div>
                `;
                list.appendChild(reqDiv);
            });
        }


        function renderFriendsPage() {
            document.getElementById("displayFriendCode").textContent = friendCode;

            const list = document.getElementById("friendListContainer");
            if (!list) return;
            list.innerHTML = "";

            if (friends.length === 0) {
                list.innerHTML = "<p>You have no friends. Add one with a friend code above!</p>";
                return;
            }

            friends.forEach(friend => {
                const statusColor = (friend.status === "Online") ? '#4caf50' : '#777';
                
                const friendDiv = document.createElement('div');
                friendDiv.style.cssText = `
                    display: flex; align-items: center; padding: 10px; background: var(--bg);
                    border-radius: 8px; margin-bottom: 8px; cursor: pointer;
                `;
                friendDiv.innerHTML = `
                    <img src="${friend.avatar || 'https://i.imgur.com/1X5Rz.png'}" alt="Avatar" 
                        style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px;"
                        onclick="openFriendProfileModal('${friend.id}')">
                    <div>
                        <strong style="color:var(--accent);">${friend.username}</strong>
                        <span style="font-size:12px; opacity:0.6;">(${friend.friendCode})</span>
                        <div style="color:${statusColor}; font-size:12px;">${friend.status}</div>
                    </div>
                    <button onclick="openChatWindow('${friend.id}', '${friend.username}')" class="tabBtn" style="margin-left: auto;">Message</button>
                `;
                list.appendChild(friendDiv);
            });
        }

        function copyFriendCode() {
            navigator.clipboard.writeText(friendCode).then(() => {
                notify("Friend Code copied!", "success");
            }).catch(err => {
                console.error('Could not copy text: ', err);
                notify("Failed to copy code.", "error");
            });
        }

        // PROFILE MODAL FUNCTIONS (Uses fetched friend data)
        function openFriendProfileModal(friendId) {
            const friend = friends.find(f => f.id === friendId);
            if (!friend) return;

            document.getElementById("modalFriendAvatar").style.backgroundImage = `url('${friend.avatar || 'https://i.imgur.com/1X5Rz.png'}')`;
            document.getElementById("modalFriendUsername").textContent = friend.username;
            document.getElementById("modalFriendStatus").textContent = friend.status;
            document.getElementById("modalFriendBio").textContent = friend.bio;
            document.getElementById("friendProfileModal").style.display = 'flex';
            document.getElementById("friendProfileModal").setAttribute('data-target-friend-id', friendId);
            document.getElementById("friendProfileModal").setAttribute('data-target-friend-name', friend.username);
        }

        function closeFriendProfileModal() {
            document.getElementById("friendProfileModal").style.display = 'none';
            document.getElementById("friendProfileModal").removeAttribute('data-target-friend-id');
            document.getElementById("friendProfileModal").removeAttribute('data-target-friend-name');
        }

        function openChatFromProfile() {
            const fId = document.getElementById("friendProfileModal").getAttribute('data-target-friend-id');
            const fName = document.getElementById("friendProfileModal").getAttribute('data-target-friend-name');
            closeFriendProfileModal();
            openChatWindow(fId, fName);
        }


        // CHAT WINDOW FUNCTIONS (Firebase Firestore Messaging)
        function getChatId(user1Id, user2Id) {
            // Ensures consistent chat ID regardless of who started the chat
            return user1Id < user2Id ? `${user1Id}_${user2Id}` : `${user2Id}_${user1Id}`;
        }

        function openChatWindow(friendId, friendUsername) {
            if (messageUnsubscribe) messageUnsubscribe(); // Stop previous listener

            const chatWindow = document.getElementById("chatWindow");
            currentChat = friendId;
            document.getElementById("chatRecipient").textContent = `Chat with ${friendUsername}`;
            chatWindow.style.display = 'block';

            const chatId = getChatId(currentUserId, friendId);
            const messagesRef = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp"));
            
            // Set up real-time listener for messages
            messageUnsubscribe = onSnapshot(messagesRef, snapshot => {
                renderMessages(friendId, snapshot.docs.map(doc => doc.data()));
            }, error => console.error("Message listener failed:", error));
        }

        function renderMessages(fId, messages) {
            const container = document.getElementById("messagesContainer");
            const shouldScroll = container.scrollTop + container.clientHeight >= container.scrollHeight - 50; // Check if near bottom
            container.innerHTML = "";
            
            messages.forEach(msg => {
                const isSelf = msg.senderId === currentUserId;
                const msgDiv = document.createElement('div');
                msgDiv.style.cssText = `
                    padding: 8px; border-radius: 10px; margin: 5px 0; max-width: 80%;
                    background: ${isSelf ? 'var(--accent)' : '#444'};
                    color: ${isSelf ? 'white' : 'var(--text)'};
                    margin-left: ${isSelf ? 'auto' : '0'};
                `;
                
                // Convert Firestore Timestamp to readable time string
                let timeStr = '...';
                if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                    timeStr = new Date(msg.timestamp.toDate()).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                }


                msgDiv.innerHTML = `
                    <small style="opacity:0.8;">${isSelf ? 'You' : msg.senderUsername}:</small><br>
                    ${msg.text}
                    <small style="display:block; text-align:right; font-size:10px; opacity:0.6;">${timeStr}</small>
                `;
                container.appendChild(msgDiv);
            });

            // Scroll to the bottom if it was near the bottom before or it's the first render
            if (shouldScroll || messages.length === 0) {
                container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage() {
            if (!currentChat || !currentUserId) return;

            const input = document.getElementById("messageInput");
            const text = input.value.trim();
            if (!text) return;

            const chatId = getChatId(currentUserId, currentChat);
            const senderUsername = profile.username || `User-${friendCode.split('-')[1]}`;

            try {
                await setDoc(doc(collection(db, "chats", chatId, "messages")), {
                    senderId: currentUserId,
                    senderUsername: senderUsername,
                    text: text,
                    timestamp: serverTimestamp()
                });

                input.value = "";
            } catch (error) {
                console.error("Error sending message:", error);
                notify("Failed to send message.", "error");
            }
        }
        
        function closeChatWindow() {
            document.getElementById("chatWindow").style.display = 'none';
            currentChat = null;
            if (messageUnsubscribe) {
                messageUnsubscribe(); // Stop listening
                messageUnsubscribe = null;
            }
        }


        /* ============================
              BASIC DATA LOAD
        ============================ */

        let recent = JSON.parse(localStorage.getItem("recent") || "[]");
        let activity = JSON.parse(localStorage.getItem("activity") || "[]");
        
        let storedProfile = localStorage.getItem("profile");
        let profile = storedProfile
            ? JSON.parse(storedProfile)
            : {
                username: "New Player", 
                bio: "Welcome to SME Launcher!",
                status: "Online",
                avatar: "https://i.imgur.com/1X5Rz.png",
            };
        
        if (!friendCode) {
            friendCode = "SME-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            localStorage.setItem("friendCode", friendCode);
        }
        
        function addRecent(name) {
            const idx = recent.indexOf(name);
            if (idx !== -1) recent.splice(idx, 1);
            recent.unshift(name);
            if (recent.length > 20) recent.pop();
            localStorage.setItem("recent", JSON.stringify(recent));
        }
        
        function addActivity(type, detail) {
            activity.unshift({
                type,
                detail,
                time: new Date().toLocaleTimeString(),
            });
            if (activity.length > 10) activity.pop();
            localStorage.setItem("activity", JSON.stringify(activity));
            if (document.getElementById('homeDashboard').classList.contains('active')) {
                renderActivityHome();
            }
        }

        /* ============================
                    HOME RENDER
        ============================ */

        function renderContinuePlaying() {
            const box = document.getElementById("continueList");
            if (!box) return;

            if (recent.length === 0) {
                box.innerHTML = "<p>No recent games.</p>";
                return;
            }

            box.innerHTML = "";
            recent.slice(0, 3).forEach((name) => {
                const g = games.find((x) => x.name === name);
                if (!g) return;
                box.innerHTML += `
                    <div class="card" style="width:150px;" onclick="launchGame('${g.name}')">
                        <img src="${g.img}" alt="${g.name}">
                        <button>${g.name}</button>
                    </div>
                `;
            });
        }

        let feed = JSON.parse(localStorage.getItem("feed") || "[]");

        function postToFeed() {
            const input = document.getElementById("feedInput");
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            const entry = {
                id: Date.now(),
                user: profile.username || "You",
                text,
                time: new Date().toLocaleTimeString(),
                likes: 0,
                comments: [],
            };

            feed.unshift(entry);
            localStorage.setItem("feed", JSON.stringify(feed));
            input.value = "";
            renderFeed();
        }

        function likePost(id) {
            const p = feed.find((x) => x.id === id);
            if (!p) return;
            p.likes++;
            localStorage.setItem("feed", JSON.stringify(feed));
            renderFeed();
        }

        function commentPost(id) {
            const msg = prompt("Write a comment:");
            if (!msg) return;

            const p = feed.find((x) => x.id === id);
            if (!p) return;

            p.comments.push({
                user: profile.username || "You",
                text: msg,
                time: new Date().toLocaleTimeString(),
            });

            localStorage.setItem("feed", JSON.stringify(feed));
            renderFeed();
        }

        function renderFeed() {
            const box = document.getElementById("feedPosts");
            if (!box) return;

            box.innerHTML = "";
            if (feed.length === 0) {
                box.innerHTML = "<p>No posts yet. Be the first!</p>";
                return;
            }

            feed.forEach((p) => {
                let commentHTML = "";
                p.comments.forEach((c) => {
                    commentHTML += `
                        <div style="margin-left:10px;opacity:.8;">
                            <b style="color:var(--accent)">${c.user}:</b> ${c.text}
                            <span style="font-size:10px;opacity:.5;">${c.time}</span>
                        </div>
                    `;
                });

                box.innerHTML += `
                    <div class="postBox">
                        <div class="postAuthor">${p.user}</div>
                        <div class="postTime">${p.time}</div>
                        <p>${p.text}</p>
                        <div class="postActions">
                            <span onclick="likePost(${p.id})">‚ù§Ô∏è ${p.likes}</span>
                            <span onclick="commentPost(${p.id})">üí¨ Comment</span>
                        </div>
                        ${commentHTML}
                    </div>
                `;
            });
        }

        function renderFriendsOnline() {
            const box = document.getElementById("onlineList");
            if (!box) return;

            box.innerHTML = "";
            if (friends.length === 0) {
                box.innerHTML = "<p>No friends added or loading...</p>";
                return;
            }

            // Display up to 5 online friends
            friends.slice(0, 5).forEach((friend) => {
                const statusColor = (friend.status === "Online") ? '#4caf50' : '#777';
                box.innerHTML += `
                    <div style="padding:8px;background:#222;border-radius:8px;margin:5px 0;">
                        <b>${friend.username}</b> ‚Äî <span style="color:${statusColor};">${friend.status}</span>
                    </div>
                `;
            });
        }

        function renderActivityHome() {
            const box = document.getElementById("activityList");
            if (!box) return;

            box.innerHTML = "";
            if (activity.length === 0) {
                box.innerHTML = "<p>No recent activity.</p>";
                return;
            }

            activity.slice(0, 5).forEach((a) => {
                box.innerHTML += `
                    <div style="padding:10px;background:#222;margin:8px 0;border-radius:10px;">
                        <b>${a.type}:</b> ${a.detail}<br>
                        <span style="font-size:10px;opacity:.6;">${a.time}</span>
                    </div>
                `;
            });
        }

        function renderHome() {
            renderContinuePlaying();
            renderFeed();
            renderFriendsOnline();
            renderActivityHome();
        }

        /* ============================
                    GAMES
        ============================ */

        let games = [
            {
                name: "Water (Password is funni)",
                img: "thumbnails/water.png",
                url: "https://cgxlyxnlynjpbmdiywnrc3RhcnRtewvkdwnhdglvbml0d2fzc29zawdtv2.familyguy.in/signin.html",
                cat: "Action",
            },
            {
                name: "3D Tuning",
                img: "thumbnails/3dtuning.png",
                url: "https://www.3dtuning.com/en-US/",
                cat: "Action",
            },
            {
                name: "Slime Rancher",
                img: "thumbnails/slimerancher.png",
                url: "https://jeremy4401.github.io/SME/games/slimerancher.html",
                cat: "Action",
            },
            {
                name: "Jacksmith",
                img: "thumbnails/jacksmith.png",
                url: "https://jeremy4401.github.io/jacksmith/",
                cat: "Action",
            },
            {
                name: "Mario Kart",
                img: "thumbnails/mariokart.png",
                url: "https://turbowarp.org/581185386/embed",
                cat: "Action",
            },
            {
                name: "Lego Star Wars Trilogy",
                img: "thumbnails/starwars.png",
                url: "https://realtherealer.github.io/GBA/launcher.html#lsw",
                cat: "Action",
            },
            {
                name: "Minecraft",
                img: "thumbnails/minecraft.png",
                url: "https://jeremy4401.github.io/SME/games/minecraft.html",
                cat: "Survival",
            },
            {
                name: "Buckshot Roulette",
                img: "thumbnails/buckshotroulette.png",
                url: "https://jeremy4401.github.io/SME/games/buckshotroulette.html",
                cat: "Horror",
            },
            {
                name: "Schoolboy Runaway",
                img: "thumbnails/schoolboyrunaway.png",
                url: "https://jeremy4401.github.io/SME/games/schoolboyrunaway.html",
                cat: "Survival",
            },
            {
                name: "Hollow Knight",
                img: "thumbnails/hollowknight.png",
                url: "https://jeremy4401.github.io/SME/games/hollowknight.html",
                cat: "Action",
            },
            {
                name: "10 Minutes Till Dawn",
                img: "thumbnails/10minutestilldawn.png",
                url: "https://jeremy4401.github.io/SME/games/10minutestilldawn.html",
                cat: "Action",
            },
            {
                name: "1v1.LOL",
                img: "thumbnails/1v1lol.png",
                url: "https://jeremy4401.github.io/SME/games/1v1lol.html",
                cat: "Action",
            },
            {
                name: "Amanda the Adventurer",
                img: "thumbnails/amandatheadventurer.png",
                url: "https://jeremy4401.github.io/SME/games/amandatheadventurer.html",
                cat: "Action",
            },
            {
                name: "Baseball Bros",
                img: "thumbnails/baseballbros.png",
                url: "https://Jeremy4401.github.io/SME/games/baseballbros.html",
                cat: "Action",
            },
            {
                name: "Basket Bros",
                img: "thumbnails/basketbros.png",
                url: "https://Jeremy4401.github.io/SME/games/basketbros.html",
                cat: "Action",
            },
            {
                name: "Football Bros",
                img: "thumbnails/footballbros.png",
                url: "https://Jeremy4401.github.io/SME/games/footballbros.html",
                cat: "Action",
            },
            {
                name: "Escape Road",
                img: "thumbnails/escaperoad.png",
                url: "https://Jeremy4401.github.io/SME/games/escaperoad.html",
                cat: "Action",
            },
            {
                name: "Fallout",
                img: "thumbnails/fallout.png",
                url: "https://Jeremy4401.github.io/SME/games/fallout.html",
                cat: "Action",
            },
            {
                name: "Flappy Bird",
                img: "thumbnails/flappybird.png",
                url: "https://Jeremy4401.github.io/SME/games/flappybird.html",
                cat: "Action",
            },
            {
                name: "FNAF 1",
                img: "thumbnails/fnaf1.png",
                url: "https://Jeremy4401.github.io/SME/games/fnaf1.html",
                cat: "Action",
            },
            {
                name: "FNAF 2",
                img: "thumbnails/fnaf2.png",
                url: "https://Jeremy4401.github.io/SME/games/fnaf2.html",
                cat: "Action",
            },
            {
                name: "FNAF 3",
                img: "thumbnails/fnaf3.png",
                url: "https://Jeremy4401.github.io/SME/games/fnaf3.html",
                cat: "Action",
            },
            {
                name: "FNAF 4",
                img: "thumbnails/fnaf4.png",
                url: "https://Jeremy4401.github.io/SME/games/fnaf4.html",
                cat: "Action",
            },
            {
                name: "FNAF 4 Halloween Edition",
                img: "thumbnails/fnaf4halloween.png",
                url: "https://Jeremy4401.github.io/SME/games/fnaf4halloween.html",
                cat: "Action",
            },
            {
                name: "Sister Location",
                img: "thumbnails/sisterlocation.png",
                url: "https://Jeremy4401.github.io/SME/games/sisterlocation.html",
                cat: "Action",
            },
            {
                name: "Freddy Fazbear's Pizzeria Simulator",
                img: "thumbnails/pizzeriasimulator.png",
                url: "https://Jeremy4401.github.io/SME/games/pizzeriasimulator.html",
                cat: "Action",
            },
            {
                name: "Ultimate Custom Night",
                img: "thumbnails/ultimatecustomnight.png",
                url: "https://Jeremy4401.github.io/SME/games/ultimatecustomnight.html",
                cat: "Action",
            },
            {
                name: "Endoparasitic",
                img: "thumbnails/endoparasitic.png",
                url: "https://Jeremy4401.github.io/SME/games/endoparasitic.html",
                cat: "Action",
            },
            {
                name: "Drive Mad",
                img: "thumbnails/drivemad.png",
                url: "https://Jeremy4401.github.io/SME/games/drivemad.html",
                cat: "Action",
            },
            {
                name: "Drift Hunters",
                img: "thumbnails/drifthunters.png",
                url: "https://Jeremy4401.github.io/SME/games/drifthunters.html",
                cat: "Action",
            },
            {
                name: "The Binding of Isaac",
                img: "thumbnails/bindingofisaac.png",
                url: "https://Jeremy4401.github.io/SME/games/bindingofisaac.html",
                cat: "Action",
            },
            {
                name: "DOOM",
                img: "thumbnails/doom.png",
                url: "https://Jeremy4401.github.io/SME/games/doom.html",
                cat: "Action",
            },
            {
                name: "DOOM 2",
                img: "thumbnails/doom2.png",
                url: "https://Jeremy4401.github.io/SME/games/doom2.html",
                cat: "Action",
            },
            {
                name: "Fruit Ninja",
                img: "thumbnails/fruitninja.png",
                url: "https://Jeremy4401.github.io/SME/games/fruitninja.html",
                cat: "Action",
            },
            {
                name: "Geometry Dash",
                img: "thumbnails/geometrydash.png",
                url: "https://Jeremy4401.github.io/SME/games/geometrydash.html",
                cat: "Action",
            },
            {
                name: "Getting Over It",
                img: "thumbnails/gettingoverit.png",
                url: "https://Jeremy4401.github.io/SME/games/gettingoverit.html",
                cat: "Action",
            },
            {
                name: "Granny",
                img: "thumbnails/granny1.png",
                url: "https://Jeremy4401.github.io/SME/games/granny1.html",
                cat: "Action",
            },
            {
                name: "Granny Chapter 2",
                img: "thumbnails/granny2.png",
                url: "https://Jeremy4401.github.io/SME/games/granny2.html",
                cat: "Action",
            },
            {
                name: "Granny Chapter 3",
                img: "thumbnails/granny3.png",
                url: "https://Jeremy4401.github.io/SME/games/granny3.html",
                cat: "Action",
            },
            {
                name: "Controlled Flight",
                img: "thumbnails/controlledflight.png",
                url: "https://howthingsfly.si.edu/sites/default/files/unity/ControlledFlight_new/index.html",
                cat: "Action",
            },
            {
                name: "Jetpack Joyride",
                img: "thumbnails/jetpackjoyride.png",
                url: "https://Jeremy4401.github.io/SME/games/jetpackjoyride.html",
                cat: "Action",
            },
            {
                name: "Johnny Trigger",
                img: "thumbnails/johnnytrigger.png",
                url: "https://Jeremy4401.github.io/SME/games/johnnytrigger.html",
                cat: "Action",
            },
            {
                name: "Kindergarten",
                img: "thumbnails/kindergarten.png",
                url: "https://Jeremy4401.github.io/SME/games/kindergarten.html",
                cat: "Action",
            },
            {
                name: "Kindergarten 2",
                img: "thumbnails/kindergarten2.png",
                url: "https://Jeremy4401.github.io/SME/games/kindergarten2.html",
                cat: "Action",
            },
            {
                name: "Kindergarten 3",
                img: "thumbnails/kindergarten3.png",
                url: "https://Jeremy4401.github.io/SME/games/kindergarten3.html",
                cat: "Action",
            },
            {
                name: "Learn to Fly",
                img: "thumbnails/learntofly.png",
                url: "https://Jeremy4401.github.io/SME/games/learntofly.html",
                cat: "Action",
            },
            {
                name: "Melon Playground",
                img: "thumbnails/melonplayground.png",
                url: "https://Jeremy4401.github.io/SME/games/melonplayground.html",
                cat: "Action",
            },
            {
                name: "Doodle Jump",
                img: "thumbnails/doodlejump.png",
                url: "https://Jeremy4401.github.io/SME/games/doodlejump.html",
                cat: "Action",
            },
            {
                name: "Nazi Zombies Portable",
                img: "thumbnails/nazizombies.png",
                url: "https://Jeremy4401.github.io/SME/games/nazizombies.html",
                cat: "Action",
            },
            {
                name: "Papers, Please",
                img: "thumbnails/papersplease.png",
                url: "https://Jeremy4401.github.io/SME/games/papersplease.html",
                cat: "Action",
            },
            {
                name: "Pixel Gun 3D",
                img: "thumbnails/pixelgun.png",
                url: "https://Jeremy4401.github.io/SME/games/pixelgun.html",
                cat: "Action",
            },
            {
                name: "Plants vs Zombies",
                img: "thumbnails/plantsvszombies.png",
                url: "https://Jeremy4401.github.io/SME/games/plantsvszombies.html",
                cat: "Action",
            },
            {
                name: "Plants vs Zombies 2 Gardenless",
                img: "thumbnails/plantsvszombies2.png",
                url: "https://Jeremy4401.github.io/SME/games/plantsvszombies2.html",
                cat: "Action",
            },
            {
                name: "Pokemon",
                img: "thumbnails/pokemon.png",
                url: "https://Jeremy4401.github.io/SME/games/pokemon.html",
                cat: "Action",
            },
            {
                name: "Raft",
                img: "thumbnails/raft.png",
                url: "https://Jeremy4401.github.io/SME/games/raft.html",
                cat: "Action",
            },
            {
                name: "Ragdoll Archers",
                img: "thumbnails/ragdollarchers.png",
                url: "https://Jeremy4401.github.io/SME/games/ragdollarchers.html",
                cat: "Action",
            },
            {
                name: "Two Player Battle",
                img: "thumbnails/2playerbattle.png",
                url: "https://turbowarp.org/292728003/embed",
                cat: "Action",
            },
            {
                name: "Retro Bowl",
                img: "thumbnails/retrobowl.png",
                url: "https://Jeremy4401.github.io/SME/games/retrobowl.html",
                cat: "Action",
            },
            {
                name: "Retro Bowl College",
                img: "thumbnails/retrobowlcollege.png",
                url: "https://Jeremy4401.github.io/SME/games/retrobowlcollege.html",
                cat: "Action",
            },
            {
                name: "Slither.io",
                img: "thumbnails/slitherio.png",
                url: "https://Jeremy4401.github.io/SME/games/slitherio.html",
                cat: "Action",
            },
            {
                name: "Slope",
                img: "thumbnails/slope.png",
                url: "https://Jeremy4401.github.io/SME/games/slope.html",
                cat: "Action",
            },
            {
                name: "Smash Karts",
                img: "thumbnails/smashkarts.png",
                url: "https://Jeremy4401.github.io/SME/games/smashkarts.html",
                cat: "Action",
            },
            {
                name: "Snow Rider 3D",
                img: "thumbnails/snowrider.png",
                url: "https://Jeremy4401.github.io/SME/games/snowrider.html",
                cat: "Action",
            },
            {
                name: "Steal a Brainrot",
                img: "thumbnails/stealabrainrot.png",
                url: "https://Jeremy4401.github.io/SME/games/stealabrainrot.html",
                cat: "Action",
            },
            {
                name: "Subway Surfers",
                img: "thumbnails/subwaysurfers.png",
                url: "https://Jeremy4401.github.io/SME/games/subwaysurfers.html",
                cat: "Action",
            },
            {
                name: "SUPERHOT",
                img: "thumbnails/superhot.png",
                url: "https://Jeremy4401.github.io/SME/games/superhot.html",
                cat: "Action",
            },
            {
                name: "Super Mario 64",
                img: "thumbnails/supermario64.png",
                url: "https://Jeremy4401.github.io/SME/games/supermario64.html",
                cat: "Action",
            },
            {
                name: "Super Mario Bros",
                img: "thumbnails/supermariobros.png",
                url: "https://Jeremy4401.github.io/SME/games/supermariobros.html",
                cat: "Action",
            },
            {
                name: "Survival Race",
                img: "thumbnails/survivalrace.png",
                url: "https://Jeremy4401.github.io/SME/games/survivalrace.html",
                cat: "Action",
            },
            {
                name: "Temple Run 2",
                img: "thumbnails/templerun2.png",
                url: "https://Jeremy4401.github.io/SME/games/templerun2.html",
                cat: "Action",
            },
            {
                name: "They are Coming",
                img: "thumbnails/theyarecoming.png",
                url: "https://Jeremy4401.github.io/SME/games/theyarecoming.html",
                cat: "Action",
            },
            {
                name: "Baldi's Basics",
                img: "thumbnails/baldisbasics.png",
                url: "https://Jeremy4401.github.io/SME/games/baldisbasics.html",
                cat: "Action",
            },
            {
                name: "Tiny Fishing",
                img: "thumbnails/tinyfishing.png",
                url: "https://Jeremy4401.github.io/SME/games/tinyfishing.html",
                cat: "Action",
            },
            {
                name: "Tomb of the Mask",
                img: "thumbnails/tombofthemask.png",
                url: "https://Jeremy4401.github.io/SME/games/tombofthemask.html",
                cat: "Action",
            },
            {
                name: "Cut the Rope",
                img: "thumbnails/cuttherope.png",
                url: "https://Jeremy4401.github.io/SME/games/cuttherope.html",
                cat: "Action",
            },
            {
                name: "Crossy Road",
                img: "thumbnails/crossyroad.png",
                url: "https://Jeremy4401.github.io/SME/games/crossyroad.html",
                cat: "Action",
            },
            {
                name: "Cookie Clicker",
                img: "thumbnails/cookieclicker.png",
                url: "https://Jeremy4401.github.io/SME/games/cookieclicker.html",
                cat: "Action",
            },
            {
                name: "Buildnow GG",
                img: "thumbnails/buildnow.png",
                url: "https://Jeremy4401.github.io/SME/games/buildnow.html",
                cat: "Action",
            },
            {
                name: "Bouncemasters",
                img: "thumbnails/bouncemasters.png",
                url: "https://Jeremy4401.github.io/SME/games/bouncemasters.html",
                cat: "Action",
            },
            {
                name: "Bitlife",
                img: "thumbnails/bitlife.png",
                url: "https://Jeremy4401.github.io/SME/games/bitlife.html",
                cat: "Action",
            },
            {
                name: "Bank Robbery 2",
                img: "thumbnails/bankrobbery2.png",
                url: "https://jeremy4401.github.io/SME/games/bankrobbery2.html",
                cat: "Action",
            },
            {
                name: "Basket Random",
                img: "thumbnails/basketrandom.png",
                url: "https://jeremy4401.github.io/SME/games/basketrandom.html",
                cat: "Action",
            },
            {
                name: "ULTRAKILL",
                img: "thumbnails/ultrakill.png",
                url: "https://jeremy4401.github.io/SME/games/ultrakill.html",
                cat: "Action",
            },
            {
                name: "Bendy & The Ink Machine",
                img: "thumbnails/bendy.png",
                url: "https://jeremy4401.github.io/SME/games/bendy.html",
                cat: "Action",
            },
            {
                name: "Cuphead",
                img: "thumbnails/cuphead.png",
                url: "https://jeremy4401.github.io/SME/games/cuphead.html",
                cat: "Action",
            },
            {
                name: "Half Life",
                img: "thumbnails/halflife.png",
                url: "https://jeremy4401.github.io/SME/games/halflife.html",
                cat: "Action",
            },
            {
                name: "R.E.P.O.",
                img: "thumbnails/repo.png",
                url: "https://jeremy4401.github.io/SME/games/repo.html",
                cat: "Action",
            },
            {
                name: "Bad Parenting",
                img: "thumbnails/badparenting.png",
                url: "https://jeremy4401.github.io/SME/games/badparenting.html",
                cat: "Horror",
            }
        ];

        let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        let categories = [...new Set(games.map((g) => g.cat))];

        function renderGames(filter = "All") {
            const sec = document.getElementById("games");
            if (!sec) return;

            // Render category buttons
            let categoryButtons = `<button class="tabBtn" onclick="renderGames('All')" style="margin-right:10px;">All</button>`;
            categories.forEach(cat => {
                categoryButtons += `<button class="tabBtn" onclick="renderGames('${cat}')" style="margin-right:10px;">${cat}</button>`;
            });
            
            sec.innerHTML = `<h2>Games Library</h2><div style="margin-bottom:20px;">${categoryButtons}</div>`;

            let filteredGames = filter === "All" ? games : games.filter(g => g.cat === filter);

            if (filteredGames.length === 0) {
                sec.innerHTML += `<p>No games found in the '${filter}' category.</p>`;
                return;
            }

            filteredGames.forEach((game) => {
                const isFav = favorites.includes(game.name) ? 'fav' : '';
                sec.innerHTML += `
                    <div class="card" onclick="openGameModal('${game.name}')">
                        <span class="star ${isFav}" onclick="event.stopPropagation(); toggleFavorite('${game.name}')">‚òÖ</span>
                        <img src="${game.img}" alt="${game.name}">
                        <h3>${game.name}</h3>
                        <p>${game.cat}</p>
                    </div>
                `;
            });
        }

        function toggleFavorite(name) {
            if (favorites.includes(name)) {
                favorites = favorites.filter(n => n !== name);
                notify(`${name} removed from favorites.`, "info");
            } else {
                favorites.push(name);
                notify(`${name} added to favorites!`, "success");
            }
            localStorage.setItem("favorites", JSON.stringify(favorites));
            
            // Re-render the current view if necessary
            if (document.getElementById('games').classList.contains('active')) renderGames();
            if (document.getElementById('favorites').classList.contains('active')) renderFavorites();
        }

        function renderFavorites() {
            const sec = document.getElementById("favorites");
            if (!sec) return;
            sec.innerHTML = "<h2>Favorites</h2>";

            if (favorites.length === 0) {
                sec.innerHTML += "<p>You have no favorites yet. Click the star on a game to add it!</p>";
                return;
            }

            favorites.forEach((name) => {
                const game = games.find(g => g.name === name);
                if (!game) return;

                sec.innerHTML += `
                    <div class="card" onclick="openGameModal('${game.name}')">
                        <span class="star fav" onclick="event.stopPropagation(); toggleFavorite('${game.name}')">‚òÖ</span>
                        <img src="${game.img}" alt="${game.name}">
                        <h3>${game.name}</h3>
                        <p>${game.cat}</p>
                    </div>
                `;
            });
        }
        
        // --- GAME MODAL LOGIC ---
        let selectedGame = null;
        
        function openGameModal(name) {
            selectedGame = games.find(g => g.name === name);
            if (!selectedGame) return;

            document.getElementById("modalImg").src = selectedGame.img;
            document.getElementById("modalTitle").textContent = selectedGame.name;
            document.getElementById("modalDesc").textContent = `Category: ${selectedGame.cat}`;
            document.getElementById("playBtn").onclick = () => launchGame(selectedGame.name);

            // Mock Playtime display
            const playtimeHours = (Math.random() * 50).toFixed(1);
            document.getElementById("playtimeBox").innerHTML = `<em>Total Playtime: ${playtimeHours} hours (Mock)</em>`;

            document.getElementById("gameModal").style.display = 'flex';
        }

        function closeGameModal() {
            document.getElementById("gameModal").style.display = 'none';
        }

        function launchGame(name) {
            const game = games.find(g => g.name === name);
            if (!game) return;

            closeGameModal();
            addRecent(name);
            addActivity("Game Played", `Started playing ${name}`);
            
            const embedFrame = document.getElementById("embedFrame");
            embedFrame.src = enc(game.url);
            document.getElementById("embedWin").style.display = 'block';

            // Optional: Hide sidebar for better immersion
            document.getElementById("sidebar").style.display = 'none';
            document.getElementById("homeBtn").style.display = 'flex';

            // Esc listener to exit game
            document.addEventListener('keydown', handleEsc, true);
        }

        function handleEsc(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                exitGame();
            }
        }

        function exitGame() {
            const embedFrame = document.getElementById("embedFrame");
            const embedWin = document.getElementById("embedWin");

            if (embedWin.style.display === 'block') {
                embedWin.style.display = 'none';
                embedFrame.src = 'about:blank'; // Stop audio/video playback

                document.getElementById("sidebar").style.display = 'flex';
                document.getElementById("homeBtn").style.display = 'none';
                document.removeEventListener('keydown', handleEsc, true);
                
                addActivity("Game Closed", `Stopped playing ${selectedGame ? selectedGame.name : 'a game'}`);
                selectedGame = null;
                renderHome(); // Refresh home dashboard
            }
        }
        
        // --- PROFILE & SETTINGS ---
        function renderProfile() {
            const sec = document.getElementById("profile");
            sec.innerHTML = `
                <h2>My Profile</h2>
                <div class="profileBanner"></div>
                <div class="profileAvatar" style="background-image:url('${profile.avatar}');"></div>
                <h1 style="margin-top:10px;">${profile.username}</h1>
                <p style="color:var(--accent);">${profile.status}</p>
                <p style="opacity:.8;">${profile.bio}</p>
                <button onclick="openSettings('profile')" class="tabBtn">Edit Profile</button>
            `;
        }

        function openSettings(tab = 'general') {
            nav('settingsPage');
            renderSettings(tab);
        }
        
        function renderSettings(tab = 'general') {
            const content = document.getElementById("settingsContent");
            if (!content) return;

            let tabContent = "";
            let buttonBar = `
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                    <button class="tabBtn" onclick="renderSettings('general')">General</button>
                    <button class="tabBtn" onclick="renderSettings('profile')">Profile</button>
                    <button class="tabBtn" onclick="renderSettings('security')">Security</button>
                </div>
            `;

            if (tab === 'general') {
                tabContent = `
                    <h3>General Settings</h3>
                    <p>Theme: <button onclick="toggleTheme()" class="tabBtn">Toggle Dark/Light</button></p>
                    <p>Friend Code: <code style="color:var(--accent);">${friendCode}</code></p>
                `;
            } else if (tab === 'profile') {
                tabContent = `
                    <h3>Edit Profile</h3>
                    <p>Username:</p>
                    <input type="text" id="settingUsername" value="${profile.username}" style="padding:8px; width:250px; border-radius:4px; border:1px solid #444; background:var(--bg); color:var(--text);"><br><br>
                    <p>Bio:</p>
                    <textarea id="settingBio" style="width:100%; height:80px; padding:8px; border-radius:4px; border:1px solid #444; background:var(--bg); color:var(--text);">${profile.bio}</textarea><br><br>
                    <p>Avatar URL:</p>
                    <input type="text" id="settingAvatar" value="${profile.avatar}" style="padding:8px; width:100%; border-radius:4px; border:1px solid #444; background:var(--bg); color:var(--text);"><br><br>
                    <button onclick="saveProfile()" class="tabBtn" style="background:var(--accent);">Save Profile</button>
                `;
            } else if (tab === 'security') {
                tabContent = `
                    <h3>Security Settings</h3>
                    <p>Account Status: <b>${currentUserId ? 'Online (Anonymous/Authenticated)' : 'Offline'}</b></p>
                    <p>To fully secure your account, you should implement a proper Firebase Email/Password or Google Sign-In.</p>
                    <button onclick="if(confirm('Are you sure you want to erase all local data?')) resetLocalData()" class="tabBtn" style="background:#c62828;">Reset Local Data</button>
                `;
            }

            content.innerHTML = buttonBar + tabContent;
        }

        async function saveProfile() {
            profile.username = document.getElementById("settingUsername").value.trim();
            profile.bio = document.getElementById("settingBio").value.trim();
            profile.avatar = document.getElementById("settingAvatar").value.trim() || 'https://i.imgur.com/1X5Rz.png';
            
            localStorage.setItem("profile", JSON.stringify(profile));
            
            if (currentUserId) {
                // Update Firebase profile
                await updateDoc(doc(db, "users", currentUserId), {
                    username: profile.username,
                    bio: profile.bio,
                    avatar: profile.avatar
                });
            }

            notify("Profile saved!", "success");
            renderProfile(); // Refresh profile page
            renderSettings('profile'); // Keep settings tab open
        }

        function resetLocalData() {
            localStorage.removeItem("recent");
            localStorage.removeItem("activity");
            localStorage.removeItem("favorites");
            localStorage.removeItem("feed");
            localStorage.removeItem("mockMessages"); // Remove old mock data
            localStorage.removeItem("profile"); 
            // Do NOT remove friendCode as it's tied to the Firebase anonymous ID
            
            // Reload the page to reset the entire state
            location.reload();
        }


        // Call renderHome initially to populate the dashboard and Games
        document.addEventListener('DOMContentLoaded', () => {
            renderHome();
            // Start listeners after Firebase init in onAuthStateChanged
        });
    </script>
</body>
</html>
