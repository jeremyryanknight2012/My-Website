<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SME - Ultimate Game & Utility Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ======================================================= */
        /* [1] GLOBAL VARIABLES & DARK CHRISTMAS THEME */
        /* ======================================================= */
        :root {
            --color-primary: #e53e3e; /* Red Accent (Christmas Red) */
            --color-secondary: #38a169; /* Green Accent (Christmas Green) */
            --color-background: #0d1117; /* Dark Base */
            --color-card-bg: #1f2937; /* Dark Slate / Card Background */
            --color-text: #f7fafc; 
            --color-text-light: #a0aec0;
            --sidebar-width: 200px;
            --friends-sidebar-width: 280px; /* New: for Friends page right sidebar */
            --transition-speed: 0.3s;

            /* Status Colors */
            --status-online: #38a169;
            --status-dnd: #e53e3e;
            --status-offline: #a0aec0;
        }

        /* Performance Mode Styles */
        .performance-mode-low :root {
            --transition-speed: 0.0s;
        }
        .performance-mode-low * {
            transition: none !important;
            animation: none !important;
            box-shadow: none !important; /* Minimize visual load */
        }
        .performance-mode-low .snow-container, .performance-mode-low .bell-fall-container {
            display: none; /* Disable heavy visual effects */
        }
        /* End Performance Mode Styles */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            text-decoration: none;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text);
            padding-left: var(--sidebar-width); /* Space for fixed sidebar */
            overflow-x: hidden;
            position: relative;
        }
        
        /* ======================================================= */
        /* [2] SIDEBAR NAVIGATION (LEFT FIXED) */
        /* ======================================================= */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--color-card-bg); 
            border-right: 2px solid var(--color-primary);
            padding: 20px 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
        }

        .sidebar-links {
            flex-grow: 1; 
        }

        .sidebar-links a {
            display: flex;
            align-items: center;
            color: var(--color-text);
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .sidebar-links a:hover, .sidebar-links a.active {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--color-primary);
        }

        .sidebar-links a span {
            margin-right: 10px;
        }
        
        /* Panic Button at bottom of sidebar */
        #panic-button {
            background-color: #ff0000; 
            color: white;
            border: none;
            padding: 15px 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            text-align: center;
        }

        #panic-button:hover {
            background-color: #cc0000;
            transform: scale(1.03);
        }

        /* ======================================================= */
        /* [3] CORE CONTENT STYLES (Base Page Layout) */
        /* ======================================================= */
        .page-content {
             padding: 40px;
             min-height: 100vh;
             display: none; /* All pages start hidden, JS shows the active one */
        }
        
        .page-content.active {
            display: block;
        }

        .section-title {
            font-size: 2em;
            color: var(--color-text);
            margin-bottom: 25px;
            border-bottom: 3px solid var(--color-secondary);
            padding-bottom: 5px;
        }
        
        /* Rows for Games & Friends (Wrap for game library) */
        #full-game-library, #favorites-game-library {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; 
            margin-top: 20px;
        }
        .content-row { /* Used for scrolling home sections */
            display: flex;
            overflow-x: scroll; 
            padding-bottom: 20px;
            gap: 15px; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none;
        }
        .content-row::-webkit-scrollbar {
            display: none;
        }

        /* Game Card Style */
        .card {
            flex-shrink: 0;
            width: 250px;
            background-color: var(--color-card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: transform var(--transition-speed);
            cursor: pointer;
            position: relative;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(229, 62, 62, 0.7); 
        }

        .card-image-container {
            width: 100%;
            height: 150px;
            background-color: var(--color-background);
            padding: 10px; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .card-image-container img {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            object-fit: contain; 
        }

        .card-details {
            padding: 10px 15px;
        }
        
        .card-details h3 {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        /* Favorites Star Styling */
        .fav-star {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 2em;
            cursor: pointer;
            transition: color 0.1s;
            z-index: 50;
        }
        .star-grey { color: var(--color-text-light); opacity: 0.6; }
        .star-yellow { color: gold; opacity: 1; }
        
        /* ======================================================= */
        /* [4] HOME PAGE SPECIFIC STYLES */
        /* ======================================================= */
        #home-sme-header {
            text-align: center;
            margin-bottom: 40px;
        }

        #home-sme-header h1 {
            font-size: 3em;
            font-weight: 800;
            color: var(--color-primary);
            text-shadow: 0 0 10px rgba(229, 62, 62, 0.5);
        }

        .friend-card {
            flex-shrink: 0;
            width: 250px;
            background-color: var(--color-card-bg);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: border-color var(--transition-speed), transform var(--transition-speed);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .friend-card:hover {
            border-color: var(--color-secondary);
            transform: translateY(-5px);
        }

        .friend-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .friend-username {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--color-text);
            cursor: pointer;
        }
        .friend-status-text {
            color: var(--color-text-light);
            font-size: 0.9em;
        }
        .friend-on-what {
            font-size: 0.9em;
            color: var(--color-primary);
            margin-top: 5px;
        }

        /* ======================================================= */
        /* [5] FULLSCREEN EMBED MODAL (For Games) */
        /* ======================================================= */
        #embed-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            z-index: 3000;
            padding: 0; 
        }

        #game-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        #close-button {
            position: absolute;
            top: 15px;
right: 30px;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 700;
            transition: background var(--transition-speed);
            z-index: 3001; 
        }

        #close-button:hover {
            background: var(--color-secondary);
        }

        /* ======================================================= */
        /* [6] THEATER PAGE STYLES (Streaming) */
        /* ======================================================= */
        .theater-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            text-align: center;
            margin-top: 20px;
        }

        .theater-section {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-primary);
        }
        
        .theater-section h3 {
            color: var(--color-primary);
            margin-bottom: 15px;
        }

        .action-btn {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background var(--transition-speed);
            margin-top: 10px;
        }
        .action-btn:hover {
            background-color: var(--color-primary);
        }

        /* ======================================================= */
        /* [7] PROXIES & REQUESTS STYLES (No Change) */
        /* ======================================================= */
        .proxy-box {
            background: var(--color-card-bg);
            border: 1px solid var(--color-primary);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            margin: 50px auto 0;
        }
        .proxy-input, .launch-btn, #proxyFrame {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 2px solid var(--color-secondary);
            background-color: var(--color-background);
            color: var(--color-text);
            font-size: 1em;
            text-align: center;
        }

        .launch-btn {
            background-color: var(--color-primary);
            cursor: pointer;
            border: none;
            font-weight: 700;
            transition: background-color var(--transition-speed);
        }
        .launch-btn:hover {
            background-color: var(--color-secondary);
        }
        
        #proxyFrame {
            display: none;
            width: 100%;
            height: 70vh;
            border: 1px solid var(--color-text-light);
            margin-top: 30px;
            border-radius: 10px;
        }
        
        .request-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .form-box {
            background: var(--color-card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--color-primary);
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--color-secondary);
            background-color: var(--color-background);
            color: var(--color-text);
        }
        .submit-btn {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color var(--transition-speed);
        }
        .submit-btn:hover {
            background-color: var(--color-primary);
        }

        /* ======================================================= */
        /* [8] FRIENDS PAGE STYLES (Messages App & Right Sidebar) */
        /* ======================================================= */
        #friends.page-content {
            padding: 0;
            display: flex;
            position: relative;
            min-height: 100vh;
        }

        /* 8.1 - Messages/Chat List (Left Side - Phone Messages look) */
        .friends-message-list {
            width: calc(100% - var(--friends-sidebar-width)); /* Take remaining width */
            padding: 20px;
            border-right: 1px solid var(--color-card-bg);
            min-height: 100vh;
            background-color: var(--color-background);
        }

        .message-thread-preview {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: var(--color-card-bg);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .message-thread-preview:hover {
            background-color: rgba(229, 62, 62, 0.15);
        }

        .thread-pfp {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: var(--color-background);
            border: 2px solid var(--color-secondary);
            overflow: hidden;
            flex-shrink: 0;
        }
        .thread-pfp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thread-info h4 {
            font-size: 1.1em;
            margin: 0;
            color: var(--color-text);
        }
        .thread-info p {
            font-size: 0.9em;
            color: var(--color-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* 8.2 - Online Friends Sidebar (Right Fixed) */
        .friends-online-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--friends-sidebar-width);
            height: 100%;
            background-color: var(--color-card-bg);
            border-left: 2px solid var(--color-secondary);
            padding: 20px 15px;
            z-index: 900;
            overflow-y: auto;
        }

        .friends-online-sidebar h3 {
            color: var(--color-secondary);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-primary);
            padding-bottom: 10px;
        }

        .online-friend-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            border-radius: 5px;
        }
        .online-friend-item:hover {
            background-color: rgba(56, 161, 105, 0.1);
        }
        
        .online-pfp {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--color-background);
            margin-right: 10px;
            position: relative;
            flex-shrink: 0;
        }
        .online-pfp img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .online-dot { /* Online status dot overlay */
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--status-online);
            border: 2px solid var(--color-card-bg);
        }
        
        .online-username {
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        /* Blank State */
        .friends-online-sidebar #online-friends-list.empty-state {
            color: var(--color-text-light);
            font-style: italic;
            text-align: center;
            padding-top: 20px;
        }


        /* ======================================================= */
        /* [9] PROFILE & SETTINGS ENHANCEMENTS */
        /* ======================================================= */
        .profile-container, .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--color-card-bg);
            padding: 30px;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* Profile Picture specific styles */
        .pfp-upload-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-background);
        }
        .pfp-upload-section label {
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
            color: var(--color-primary);
        }
        #pfp-url-input, #profile-section-content input, #profile-section-content textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        .pfp-upload-controls {
            display: flex;
            gap: 10px;
        }
        .pfp-upload-controls button {
            flex-grow: 1;
        }

        .pfp-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--color-text-light);
        }

        /* Settings grid for buttons */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .setting-card {
            background-color: var(--color-background);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-secondary);
        }
        .setting-card h4 {
            margin-bottom: 15px;
            color: var(--color-primary);
        }
        .setting-card button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity var(--transition-speed);
        }
        .setting-card button:hover {
            opacity: 0.8;
        }
        
        .setting-btn-primary {
            background-color: var(--color-primary);
            color: white;
            border: none;
        }
        .setting-btn-secondary {
            background-color: #2b6cb0; /* Blue for utilities */
            color: white;
            border: none;
        }
        
        /* Profile Header */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 20px;
            border: 4px solid var(--color-primary);
            flex-shrink: 0;
        }

        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 1.5em;
            color: var(--color-secondary);
        }


        /* ======================================================= */
        /* [10] VISUAL EFFECTS (Snow & Bells) */
        /* ======================================================= */
        .snow-container, .bell-fall-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 500;
        }
        
        .flake {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: fall linear infinite;
        }
        
        .bell {
            position: absolute;
            font-size: 1.5em;
            color: gold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            animation: fall-bell linear infinite;
        }

        @keyframes fall {
            0% { transform: translate3d(0, -10vh, 0); opacity: 0; }
            5% { opacity: 0.9; }
            100% { transform: translate3d(0, 110vh, 0); opacity: 0; }
        }

        @keyframes fall-bell {
            0% { transform: translate3d(0, -10vh, 0) rotate(0deg); opacity: 0; }
            5% { opacity: 0.8; }
            100% { transform: translate3d(0, 110vh, 0) rotate(720deg); opacity: 0; }
        }
        
    </style>
</head>
<body class="performance-mode-low"> <div class="snow-container" id="snow-container"></div>
    <div class="bell-fall-container" id="bell-container"></div>
    <nav class="sidebar">
        <div class="sidebar-links">
            <a href="#home" class="nav-link active"><span>üè†</span>Home</a>
            <a href="#games" class="nav-link"><span>üéÆ</span>Games</a>
            <a href="#favorites" class="nav-link"><span>‚≠ê</span>Favorites</a>
            <a href="#theater" class="nav-link"><span>üé¨</span>Theater</a>
            <a href="#proxies" class="nav-link"><span>üåê</span>Proxies</a>
            <a href="#requests" class="nav-link"><span>üìß</span>Requests</a>
            <a href="#settings" class="nav-link"><span>‚öôÔ∏è</span>Settings</a>
            <a href="#friends" class="nav-link"><span>ü§ù</span>Friends</a>
            <a href="#profile" class="nav-link"><span>üë§</span>Profile</a>
        </div>
        <button id="panic-button" onclick="triggerPanic()">üö® PANIC</button>
    </nav>

    <main>
        
        <div id="home" class="page-content active">
            <div id="home-sme-header">
                <h1>SME</h1>
                <p style="color: var(--color-text-light);">Your personal game and study hub.</p>
            </div>
            
            <h2 class="section-title" style="border-bottom-color: var(--color-primary);">Recently Played (Last 5)</h2>
            <div class="content-row" id="recent-played-row">
                <p style="color: var(--color-text-light); padding: 10px;">Play a game from the Games page to see it appear here!</p>
            </div>

            <h2 class="section-title" style="border-bottom-color: var(--color-secondary);">Friends Status</h2>
            <div class="content-row" id="home-friends-list">
                <div class="friend-card" onclick="viewOtherProfile('GamerPro')">
                    <div class="friend-status">
                        <div class="status-dot" style="background-color: var(--status-online);"></div>
                        <span class="friend-status-text">Online</span>
                    </div>
                    <span class="friend-username">GamerPro</span>
                    <p class="friend-on-what">Playing: Drive Mad</p>
                </div>
                <div class="friend-card" onclick="viewOtherProfile('StudySavant')">
                    <div class="friend-status">
                        <div class="status-dot" style="background-color: var(--status-dnd);"></div>
                        <span class="friend-status-text">Do Not Disturb</span>
                    </div>
                    <span class="friend-username">StudySavant</span>
                    <p class="friend-on-what">Status: Studying Math</p>
                </div>
                <div class="friend-card" onclick="viewOtherProfile('QuietUser')">
                    <div class="friend-status">
                        <div class="status-dot" style="background-color: var(--status-offline);"></div>
                        <span class="friend-status-text">Offline</span>
                    </div>
                    <span class="friend-username">QuietUser</span>
                    <p class="friend-on-what">Last seen: 2 days ago</p>
                </div>
            </div>
        </div>
        
        <div id="games" class="page-content">
            <h2 class="section-title">Games Library (82 Games)</h2>
            <div id="full-game-library">
            
                <div class="card" id="game-10-minutes-till-dawn" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/10-minutes-till-dawn.html', '10 Minutes Till Dawn')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-10-minutes-till-dawn', '10 Minutes Till Dawn')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/10-minutes-till-dawn.png" alt="10 Minutes Till Dawn Icon"></div>
                    <div class="card-details"><h3>10 Minutes Till Dawn</h3><p>Survive the endless horde!</p></div>
                </div>
                <div class="card" id="game-1v1-lol" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/1v1-lol.html', '1v1.LOL')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-1v1-lol', '1v1.LOL')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/1v1-lol.png" alt="1v1.LOL Icon"></div>
                    <div class="card-details"><h3>1v1.LOL</h3><p>Competitive shooter and building game.</p></div>
                </div>
                <div class="card" id="game-amanda-the-adventurer" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/amanda-the-adventurer.html', 'Amanda the Adventurer')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-amanda-the-adventurer', 'Amanda the Adventurer')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/amanda-the-adventurer.png" alt="Amanda the Adventurer Icon"></div>
                    <div class="card-details"><h3>Amanda the Adventurer</h3><p>Spooky children's show horror game.</p></div>
                </div>
                <div class="card" id="game-bad-parenting" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bad-parenting.html', 'Bad Parenting')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bad-parenting', 'Bad Parenting')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bad-parenting.png" alt="Bad Parenting Icon"></div>
                    <div class="card-details"><h3>Bad Parenting</h3><p>Chaotic family life simulator.</p></div>
                </div>
                <div class="card" id="game-baldis-basics" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/baldis-basics.html', 'Baldi\'s Basics')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-baldis-basics', 'Baldi\'s Basics')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/baldis-basics.png" alt="Baldi's Basics Icon"></div>
                    <div class="card-details"><h3>Baldi's Basics</h3><p>Education and learning horror game.</p></div>
                </div>
                <div class="card" id="game-bank-robbery-2" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bank-robbery-2.html', 'Bank Robbery 2')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bank-robbery-2', 'Bank Robbery 2')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bank-robbery-2.png" alt="Bank Robbery 2 Icon"></div>
                    <div class="card-details"><h3>Bank Robbery 2</h3><p>Plan and execute the perfect heist.</p></div>
                </div>
                <div class="card" id="game-baseball-bros" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/baseball-bros.html', 'Baseball Bros')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-baseball-bros', 'Baseball Bros')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/baseball-bros.png" alt="Baseball Bros Icon"></div>
                    <div class="card-details"><h3>Baseball Bros</h3><p>Fast-paced baseball action.</p></div>
                </div>
                <div class="card" id="game-basketball-stars" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/basketball-stars.html', 'Basketball Stars')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-basketball-stars', 'Basketball Stars')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/basketball-stars.png" alt="Basketball Stars Icon"></div>
                    <div class="card-details"><h3>Basketball Stars</h3><p>Online 2-player basketball.</p></div>
                </div>
                <div class="card" id="game-basket-bros" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/basket-bros.html', 'Basket Bros')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-basket-bros', 'Basket Bros')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/basket-bros.png" alt="Basket Bros Icon"></div>
                    <div class="card-details"><h3>Basket Bros</h3><p>Funny and physics-based basketball.</p></div>
                </div>
                <div class="card" id="game-basket-random" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/basket-random.html', 'Basket Random')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-basket-random', 'Basket Random')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/basket-random.png" alt="Basket Random Icon"></div>
                    <div class="card-details"><h3>Basket Random</h3><p>Wacky and unpredictable 2-player basketball.</p></div>
                </div>
                <div class="card" id="game-bendy" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bendy.html', 'Bendy')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bendy', 'Bendy')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bendy.png" alt="Bendy Icon"></div>
                    <div class="card-details"><h3>Bendy</h3><p>First-person survival horror.</p></div>
                </div>
                <div class="card" id="game-the-binding-of-isaac" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/the-binding-of-isaac.html', 'The Binding of Isaac')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-the-binding-of-isaac', 'The Binding of Isaac')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/the-binding-of-isaac.png" alt="The Binding of Isaac Icon"></div>
                    <div class="card-details"><h3>The Binding of Isaac</h3><p>Dungeon crawling rogue-lite.</p></div>
                </div>
                <div class="card" id="game-bitlife" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bitlife.html', 'BitLife')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bitlife', 'BitLife')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bitlife.png" alt="BitLife Icon"></div>
                    <div class="card-details"><h3>BitLife</h3><p>Life simulator where every choice matters.</p></div>
                </div>
                <div class="card" id="game-bottle-jump-3d" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bottle-jump-3d.html', 'Bottle Jump 3D')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bottle-jump-3d', 'Bottle Jump 3D')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bottle-jump-3d.png" alt="Bottle Jump 3D Icon"></div>
                    <div class="card-details"><h3>Bottle Jump 3D</h3><p>Master the art of the bottle flip.</p></div>
                </div>
                <div class="card" id="game-bouncemasters" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bouncemasters.html', 'Bouncemasters')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bouncemasters', 'Bouncemasters')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bouncemasters.png" alt="Bouncemasters Icon"></div>
                    <div class="card-details"><h3>Bouncemasters</h3><p>Launch a penguin as far as possible.</p></div>
                </div>
                <div class="card" id="game-bowmasters" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/bowmasters.html', 'Bowmasters')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-bowmasters', 'Bowmasters')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/bowmasters.png" alt="Bowmasters Icon"></div>
                    <div class="card-details"><h3>Bowmasters</h3><p>Aim and shoot physics game.</p></div>
                </div>
                <div class="card" id="game-buckshot-roulette" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/buckshot-roulette.html', 'Buckshot Roulette')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-buckshot-roulette', 'Buckshot Roulette')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/buckshot-roulette.png" alt="Buckshot Roulette Icon"></div>
                    <div class="card-details"><h3>Buckshot Roulette</h3><p>A deadly game of chance.</p></div>
                </div>
                <div class="card" id="game-buildnowgg" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/games/buildnowgg.html', 'BuildNow.gg')">
                    <span class="fav-star star-grey" onclick="toggleFavorite(event, 'game-buildnowgg', 'BuildNow.gg')">‚òÖ</span>
                    <div class="card-image-container"><img src="https://jeremy4401.github.io/StudyMath/games/buildnowgg.png" alt="BuildNow.gg Icon"></div>
                    <div class="card-details"><h3>BuildNow.gg</h3><p>Competitive builder shooter.</p></div>
                </div>
                </div>
        </div>

        <div id="favorites" class="page-content">
            <h2 class="section-title">‚≠ê Your Favorite Games</h2>
            <div id="favorites-game-library">
                <p style="color: var(--color-text-light);">Click the star on a game card in the Games page to add it here!</p>
            </div>
        </div>

        <div id="theater" class="page-content">
            <h2 class="section-title">üé¨ Private Theater & Streaming</h2>
            <div class="theater-grid">
                <div class="theater-section">
                    <h3>YouTube Watch Party</h3>
                    <p style="color: var(--color-text-light);">Watch a YouTube video synced with friends.</p>
                    <input type="text" placeholder="YouTube Video ID or URL" style="width: 100%; padding: 10px; margin-top: 15px; background: var(--color-background); border: 1px solid var(--color-text-light); color: var(--color-text); border-radius: 5px;">
                    <button class="action-btn">Launch Watch Party</button>
                </div>
                <div class="theater-section">
                    <h3>Movie Stream</h3>
                    <p style="color: var(--color-text-light);">Access private streaming services.</p>
                    <button class="action-btn" onclick="openEmbedURL('https://jeremy4401.github.io/StudyMath/streaming/movies.html', 'Movie Stream')">Open Streamer</button>
                </div>
            </div>
        </div>

        <div id="proxies" class="page-content">
            <h2 class="section-title">üåê Web Proxies</h2>
            <div class="proxy-box">
                <h2>Launch Proxy</h2>
                <input type="text" id="proxyUrl" class="proxy-input" placeholder="Enter URL (e.g., youtube.com or https://example.com)">
                <button class="launch-btn" onclick="launchProxy()">Launch</button>
            </div>
            <iframe id="proxyFrame"></iframe>
        </div>

        <div id="requests" class="page-content">
            <h2 class="section-title">üìß Feature/Game Requests</h2>
            <div class="request-container">
                <div class="form-box">
                    <h2>Submit a Request</h2>
                    <form id="requestForm">
                        <div class="form-group">
                            <label for="requestType">Request Type:</label>
                            <select id="requestType" required>
                                <option value="game">Game Addition</option>
                                <option value="feature">New Feature</option>
                                <option value="bug">Bug Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="requestTitle">Title/Game Name (Use official names):</label>
                            <input type="text" id="requestTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="requestDetails">Details (URL for games, explanation for features):</label>
                            <textarea id="requestDetails" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="submit-btn">Submit Request</button>
                    </form>
                    <p id="form-message"></p>
                </div>
            </div>
        </div>
        
        <div id="settings" class="page-content">
            <h2 class="section-title">‚öôÔ∏è Application Settings</h2>
            <div class="settings-container">
                <div class="settings-grid">
                    
                    <div class="setting-card">
                        <h4>Performance Mode</h4>
                        <p style="font-size: 0.9em; color: var(--color-text-light); margin-bottom: 10px;">Disable animations/effects for faster speed.</p>
                        <button id="performance-toggle" class="setting-btn-primary" onclick="togglePerformanceMode()">
                            Enable Low Mode
                        </button>
                    </div>

                    <div class="setting-card">
                        <h4>Export Data</h4>
                        <p style="font-size: 0.9em; color: var(--color-text-light); margin-bottom: 10px;">Download your user data (favorites, settings).</p>
                        <button class="setting-btn-secondary" onclick="exportData()">
                            Export JSON
                        </button>
                    </div>

                    <div class="setting-card">
                        <h4>Import Data</h4>
                        <p style="font-size: 0.9em; color: var(--color-text-light); margin-bottom: 10px;">Upload a previous JSON backup file.</p>
                        <input type="file" id="import-file" style="display: none;" accept=".json">
                        <button class="setting-btn-secondary" onclick="document.getElementById('import-file').click();">
                            Import JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="friends" class="page-content">
            <div class="friends-message-list">
                <h2 class="section-title" style="margin-top: 0; padding-top: 20px; border-bottom: 3px solid var(--color-primary);">Chats & Messages</h2>
                
                <div class="message-thread-preview" onclick="openChat('gamerpro')">
                    <div class="thread-pfp"><img src="https://via.placeholder.com/50x50.png?text=GP" alt="GamerPro PFP"></div>
                    <div class="thread-info">
                        <h4>GamerPro <span style="font-weight: 400; font-size: 0.8em; color: var(--color-text-light); float: right;">10:30 AM</span></h4>
                        <p>Hey, want to try the new 1v1.LOL map?</p>
                    </div>
                </div>
                
                <div class="message-thread-preview" onclick="openChat('studysavant')">
                    <div class="thread-pfp"><img src="https://via.placeholder.com/50x50.png?text=SS" alt="StudySavant PFP"></div>
                    <div class="thread-info">
                        <h4>StudySavant <span style="font-weight: 400; font-size: 0.8em; color: var(--color-text-light); float: right;">Yesterday</span></h4>
                        <p>Finished the assignment, thanks for the help!</p>
                    </div>
                </div>

                <p id="no-chats-message" style="color: var(--color-text-light); font-style: italic; text-align: center; margin-top: 50px; display: none;">No current active chats. Start a conversation from the Online Friends list!</p>
            </div>

            <div class="friends-online-sidebar">
                <h3>Online Friends</h3>
                <div id="online-friends-list">
                    <div class="online-friend-item" onclick="openChat('gamerpro')">
                        <div class="online-pfp"><img src="https://via.placeholder.com/35x35.png?text=GP" alt="PFP"><div class="online-dot"></div></div>
                        <span class="online-username">GamerPro</span>
                    </div>
                    <div class="online-friend-item" onclick="openChat('coderkid')">
                        <div class="online-pfp"><img src="https://via.placeholder.com/35x35.png?text=CK" alt="PFP"><div class="online-dot"></div></div>
                        <span class="online-username">CoderKid</span>
                    </div>
                    <p id="empty-friends-placeholder" class="empty-state">
                        You haven't added any friends yet or no one is online.
                    </p>
                </div>
            </div>
        </div>

        <div id="profile" class="page-content">
            <h2 class="section-title">üë§ Your Profile</h2>
            <div class="profile-container">
                
                <div class="profile-header">
                    <div class="profile-pic" id="current-pfp-container">
                        <img id="profile-picture" src="https://via.placeholder.com/100x100.png?text=User" alt="Profile Picture">
                    </div>
                    <div class="profile-info">
                        <h3 id="profile-username">Current User</h3>
                        <p style="color: var(--color-text-light);">Status: Ready to game or study!</p>
                    </div>
                </div>
                
                <hr style="border-color: var(--color-secondary); margin: 20px 0;">

                <div class="pfp-upload-section">
                    <label for="pfp-url-input">Change Profile Picture (PNG/JPG URL):</label>
                    <input type="text" id="pfp-url-input" placeholder="Paste PNG or JPG URL here (e.g., https://jeremy4401.github.io/StudyMath/pfp.png)">
                    
                    <div class="pfp-upload-controls">
                        <button class="setting-btn-primary" onclick="updatePfpFromUrl()">Use URL</button>
                        <input type="file" id="pfp-file-input" accept="image/png, image/jpeg" style="display: none;" onchange="uploadPfpFile(event)">
                        <button class="setting-btn-secondary" onclick="document.getElementById('pfp-file-input').click()">Upload File (PNG/JPG)</button>
                    </div>

                    <p class="pfp-status" id="pfp-status-message">Requires Firebase Storage to save uploaded files.</p>
                </div>

                <hr style="border-color: var(--color-secondary); margin: 20px 0;">

                <div class="profile-section-content" id="profile-section-content">
                    <h4>Account Details (Placeholder)</h4>
                    <label>Username:</label>
                    <input type="text" value="Current User" readonly>
                    
                    <label>Bio:</label>
                    <textarea>Your personal bio goes here. What are you playing?</textarea>
                    
                    <button class="action-btn" style="width: auto;">Save Profile</button>
                </div>
            </div>
        </div>
        
    </main>

    <div id="embed-container">
        <button id="close-button" onclick="closeEmbed()">CLOSE</button>
        <iframe id="game-iframe" allowfullscreen></iframe>
    </div>

<script type="module">
    // =======================================================
    // [A] FIREBASE MODULAR SDK IMPORTS (CDN Style)
    // =======================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref as dbRef, set, get } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBxXsXA1aoOLzDD-yNaZnHETgxPAJ-mbjw",
        authDomain: "sme-loader.firebaseapp.com",
        databaseURL: "https://sme-loader-default-rtdb.firebaseio.com",
        projectId: "sme-loader",
        storageBucket: "sme-loader.firebasestorage.app",
        messagingSenderId: "427113600756",
        appId: "1:427113600756:web:73227a309d4a2e6c51b0a1"
    };

    // Initialize Firebase App and Services
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Placeholder User ID (for saving PFP and settings data)
    const CURRENT_USER_ID = "guest_user_12345"; 
    const CURRENT_USERNAME = "CurrentUser";

    // =======================================================
    // [B] CORE NAVIGATION & UTILITY FUNCTIONS
    // =======================================================
    
    // Attaching utility functions to the window so the HTML 'onclick' attributes can call them
    window.loadUserProfileData = loadUserProfileData;
    window.updatePfpFromUrl = updatePfpFromUrl;
    window.uploadPfpFile = uploadPfpFile;
    window.openEmbedURL = openEmbedURL;
    window.closeEmbed = closeEmbed;
    window.toggleFavorite = toggleFavorite;
    window.openChat = openChat; // Added for Friends page chat simulation
    window.triggerPanic = triggerPanic;
    window.launchProxy = launchProxy;
    window.togglePerformanceMode = togglePerformanceMode;
    window.exportData = exportData;
    window.importDataFromFile = importDataFromFile;

    // Function to handle page switching
    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${pageId}`) {
                link.classList.add('active');
            }
        });

        if (pageId === 'friends') {
            document.body.style.paddingRight = 'var(--friends-sidebar-width)';
            loadOnlineFriends();
        } else {
            document.body.style.paddingRight = '0';
        }
        
        history.pushState(null, null, `#${pageId}`);
    }

    // Function to handle the Panic Button
    function triggerPanic() {
        window.location.replace("https://www.google.com/");
    }

    // Function to launch games in the embed container (FULL URL handled)
    function openEmbedURL(fullUrl, gameName) {
        document.getElementById('game-iframe').src = fullUrl;
        document.getElementById('embed-container').style.display = 'block';
        document.body.style.overflow = 'hidden'; 

        const slugMatch = fullUrl.match(/\/games\/(.+?)\.html$/);
        const gameSlug = slugMatch ? slugMatch[1] : gameName.toLowerCase().replace(/\s/g, '-').replace(/[^\w-]/g, '');
        const imagePath = `https://jeremy4401.github.io/StudyMath/games/${gameSlug}.png`;
        
        addRecentlyPlayed(gameName, imagePath, fullUrl); 
    }

    function closeEmbed() {
        document.getElementById('game-iframe').src = 'about:blank';
        document.getElementById('embed-container').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Function to launch Proxies
    function launchProxy() {
        const urlInput = document.getElementById('proxyUrl').value.trim();
        const proxyFrame = document.getElementById('proxyFrame');
        if (urlInput) {
            let finalUrl = urlInput;
            if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                finalUrl = 'https://' + finalUrl;
            }
            proxyFrame.src = finalUrl;
            proxyFrame.style.display = 'block';
        } else {
            alert("Please enter a URL for the proxy.");
        }
    }


    // =======================================================
    // [C] GAME & FAVORITES LOGIC
    // =======================================================

    let favorites = JSON.parse(localStorage.getItem('favorites')) || {};
    let recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayed')) || [];

    // Toggles a game's favorite status
    function toggleFavorite(event, gameId, gameName) {
        event.stopPropagation(); 
        const star = document.querySelector(`#${gameId} .fav-star`);

        const gameCard = document.getElementById(gameId);
        const onClickAttr = gameCard.getAttribute('onclick');
        const urlMatch = onClickAttr.match(/'(.*?)'/);
        const url = urlMatch ? urlMatch[1] : '';
        const image = gameCard.querySelector('img').src;


        if (favorites[gameId]) {
            delete favorites[gameId];
            star.classList.remove('star-yellow');
            star.classList.add('star-grey');
        } else {
            favorites[gameId] = {
                id: gameId,
                name: gameName,
                url: url,
                image: image
            };
            star.classList.remove('star-grey');
            star.classList.add('star-yellow');
        }
        
        localStorage.setItem('favorites', JSON.stringify(favorites));
        loadFavorites();
    }

    // Loads favorites into the #favorites page
    function loadFavorites() {
        const favContainer = document.getElementById('favorites-game-library');
        favContainer.innerHTML = ''; 

        const favArray = Object.values(favorites);
        if (favArray.length === 0) {
            favContainer.innerHTML = '<p style="color: var(--color-text-light);">Click the star on a game card in the Games page to add it here!</p>';
            return;
        }

        favArray.forEach(game => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = game.id;
            card.setAttribute('onclick', `openEmbedURL('${game.url}', '${game.name}')`);
            
            card.innerHTML = `
                <span class="fav-star star-yellow" onclick="toggleFavorite(event, '${game.id}', '${game.name}')">‚òÖ</span>
                <div class="card-image-container"><img src="${game.image}" alt="${game.name} Icon"></div>
                <div class="card-details"><h3>${game.name}</h3><p>Your favorite!</p></div>
            `;
            favContainer.appendChild(card);
        });
    }

    // Records a game when it is launched
    function addRecentlyPlayed(gameName, imageSrc, gameUrl) {
        recentlyPlayed = recentlyPlayed.filter(g => g.name !== gameName);
        recentlyPlayed.unshift({ name: gameName, image: imageSrc, url: gameUrl });

        if (recentlyPlayed.length > 5) {
            recentlyPlayed.pop();
        }

        localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
        updateRecentPlayedUI();
    }

    function updateRecentPlayedUI() {
        const recentContainer = document.getElementById('recent-played-row');
        recentContainer.innerHTML = '';
        
        if (recentlyPlayed.length === 0) {
            recentContainer.innerHTML = '<p style="color: var(--color-text-light); padding: 10px;">Play a game from the Games page to see it appear here!</p>';
            return;
        }

        recentlyPlayed.forEach(game => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.width = '180px'; 
            card.setAttribute('onclick', `openEmbedURL('${game.url}', '${game.name}')`);
            
            card.innerHTML = `
                <div class="card-image-container" style="height: 100px;"><img src="${game.image}" alt="${game.name} Icon"></div>
                <div class="card-details"><h3>${game.name}</h3></div>
            `;
            recentContainer.appendChild(card);
        });
    }


    // =======================================================
    // [D] PROFILE PAGE LOGIC (PFP Management - MODULAR)
    // =======================================================

    function loadUserProfileData() {
        const pfpUrl = localStorage.getItem('userPfpUrl') || "https://via.placeholder.com/100x100.png?text=User";
        document.getElementById('profile-picture').src = pfpUrl;
        document.getElementById('profile-username').textContent = CURRENT_USERNAME;
        document.getElementById('pfp-url-input').value = pfpUrl === "https://via.placeholder.com/100x100.png?text=User" ? '' : pfpUrl;
    }

    function updatePfpFromUrl() {
        const url = document.getElementById('pfp-url-input').value.trim();
        const statusMsg = document.getElementById('pfp-status-message');

        if (url && url.toLowerCase().match(/\.(png|jpe?g)$/)) {
            localStorage.setItem('userPfpUrl', url);
            document.getElementById('profile-picture').src = url;
            statusMsg.textContent = "Profile picture updated successfully from URL!";
            statusMsg.style.color = 'var(--status-online)';
            
            // OPTIONAL: Save to Realtime Database
            // set(dbRef(db, 'users/' + CURRENT_USER_ID + '/pfpUrl'), url);

        } else {
            statusMsg.textContent = "Please use a valid image URL ending in .png, .jpg, or .jpeg.";
            statusMsg.style.color = 'var(--status-dnd)';
        }
    }

    function uploadPfpFile(event) {
        const file = event.target.files[0];
        const statusMsg = document.getElementById('pfp-status-message');
        
        if (!file) return;
        if (!file.type.match('image/png') && !file.type.match('image/jpeg')) {
            statusMsg.textContent = "Only PNG and JPG files are supported for upload.";
            statusMsg.style.color = 'var(--status-dnd)';
            return;
        }

        statusMsg.textContent = `Uploading ${file.name}...`;
        statusMsg.style.color = '#ffc107'; 

        const fileExtension = file.name.split('.').pop();
        const imageRef = storageRef(storage, `profile_pictures/${CURRENT_USER_ID}.${fileExtension}`);
        const uploadTask = uploadBytesResumable(imageRef, file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                statusMsg.textContent = `Upload is ${Math.round(progress)}% done.`;
            }, 
            (error) => {
                console.error("Upload failed:", error);
                statusMsg.textContent = `Upload failed: ${error.message}`;
                statusMsg.style.color = 'var(--status-dnd)';
            }, 
            () => {
                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                    localStorage.setItem('userPfpUrl', downloadURL);
                    document.getElementById('profile-picture').src = downloadURL;
                    document.getElementById('pfp-url-input').value = downloadURL;
                    statusMsg.textContent = "File uploaded and PFP updated successfully!";
                    statusMsg.style.color = 'var(--status-online)';
                    // OPTIONAL: Save to Realtime Database
                    // set(dbRef(db, 'users/' + CURRENT_USER_ID + '/pfpUrl'), downloadURL);
                });
            }
        );
    }


    // =======================================================
    // [E] FRIENDS PAGE LOGIC (Dummy Data for UI)
    // =======================================================
    const dummyOnlineFriends = [
        { id: 'gamerpro', username: 'GamerPro', status: 'Online', pfp: 'https://via.placeholder.com/35x35.png?text=GP' },
        { id: 'coderkid', username: 'CoderKid', status: 'Online', pfp: 'https://via.placeholder.com/35x35.png?text=CK' },
        { id: 'studybuddy', username: 'StudyBuddy', status: 'Online', pfp: 'https://via.placeholder.com/35x35.png?text=SB' },
        { id: 'longnamefriendonline', username: 'L.N.FriendOnline', status: 'Online', pfp: 'https://via.placeholder.com/35x35.png?text=LN' }
    ];
    
    function loadOnlineFriends() {
        const list = document.getElementById('online-friends-list');
        // Keep the placeholder if no friends are online
        const placeholder = document.getElementById('empty-friends-placeholder');
        
        // Remove existing dynamic friends, but keep the static placeholder
        Array.from(list.children).forEach(child => {
            if (child.classList.contains('online-friend-item')) {
                child.remove();
            }
        });

        if (dummyOnlineFriends.length === 0) {
            placeholder.style.display = 'block';
            return;
        }
        
        placeholder.style.display = 'none';

        dummyOnlineFriends.forEach(friend => {
            const item = document.createElement('div');
            item.className = 'online-friend-item';
            item.setAttribute('onclick', `openChat('${friend.id}')`);
            
            item.innerHTML = `
                <div class="online-pfp">
                    <img src="${friend.pfp}" alt="${friend.username} PFP">
                    <div class="online-dot"></div>
                </div>
                <span class="online-username">${friend.username}</span>
            `;
            // Insert before the placeholder
            list.insertBefore(item, placeholder);
        });
    }

    function openChat(friendId) {
        alert(`Opening chat with ${friendId}. (This would open a chat interface in a real app)`);
    }

    // =======================================================
    // [F] SETTINGS LOGIC (Performance, Export/Import)
    // =======================================================
    let snowfallInterval;
    let bellfallInterval;

    function createFlake() {
        const flake = document.createElement('div');
        flake.classList.add('flake');
        flake.style.width = `${Math.random() * 5 + 2}px`;
        flake.style.height = flake.style.width;
        flake.style.left = `${Math.random() * 100}vw`;
        flake.style.animationDuration = `${Math.random() * 8 + 5}s`;
        flake.style.animationDelay = `-${Math.random() * 10}s`;
        document.getElementById('snow-container').appendChild(flake);
        setTimeout(() => flake.remove(), 15000); 
    }

    function createBell() {
        const bell = document.createElement('div');
        bell.classList.add('bell');
        bell.textContent = 'üîî'; 
        bell.style.left = `${Math.random() * 100}vw`;
        bell.style.animationDuration = `${Math.random() * 10 + 8}s`;
        bell.style.animationDelay = `-${Math.random() * 20}s`;
        document.getElementById('bell-container').appendChild(bell);
        setTimeout(() => bell.remove(), 25000); 
    }

    function startSnowfall() {
        if (snowfallInterval) return;
        snowfallInterval = setInterval(createFlake, 100);
        bellfallInterval = setInterval(createBell, 1500);
    }
    
    function stopSnowfall() {
        clearInterval(snowfallInterval);
        clearInterval(bellfallInterval);
        snowfallInterval = null;
        bellfallInterval = null;
        document.getElementById('snow-container').innerHTML = '';
        document.getElementById('bell-container').innerHTML = '';
    }
    
    // Performance Mode Toggle
    function togglePerformanceMode(forceLow = false) {
        const body = document.body;
        const button = document.getElementById('performance-toggle');
        
        if (body.classList.contains('performance-mode-low') && !forceLow) {
            body.classList.remove('performance-mode-low');
            button.textContent = 'Enable Low Mode';
            localStorage.setItem('performanceMode', 'high');
            startSnowfall();
        } else {
            body.classList.add('performance-mode-low');
            button.textContent = 'Disable Low Mode';
            localStorage.setItem('performanceMode', 'low');
            stopSnowfall();
        }
    }
    
    // Export Data Function
    function exportData() {
        const data = {
            version: '1.0',
            exportedAt: new Date().toISOString(),
            favorites: favorites,
            recentlyPlayed: recentlyPlayed,
            userPfpUrl: localStorage.getItem('userPfpUrl') || '',
            performanceMode: localStorage.getItem('performanceMode') || 'high'
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sme_backup_${new Date().toLocaleDateString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Data exported successfully!');
    }

    // Import Data Function (triggered by file input 'change' event)
    function importDataFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (importedData.favorites) {
                    favorites = importedData.favorites;
                    localStorage.setItem('favorites', JSON.stringify(favorites));
                    loadFavorites();
                }
                if (importedData.recentlyPlayed) {
                    recentlyPlayed = importedData.recentlyPlayed;
                    localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
                    updateRecentPlayedUI();
                }
                
                if (importedData.userPfpUrl) {
                    localStorage.setItem('userPfpUrl', importedData.userPfpUrl);
                    loadUserProfileData(); 
                }
                
                const currentMode = localStorage.getItem('performanceMode');
                const importedMode = importedData.performanceMode || 'high';
                if (currentMode !== importedMode) {
                    // Check button text state to decide if we need to call with force true/false
                    const isCurrentlyLow = document.body.classList.contains('performance-mode-low');
                    if (importedMode === 'low' && !isCurrentlyLow) {
                         togglePerformanceMode(false); // Call with false to toggle ON
                    } else if (importedMode === 'high' && isCurrentlyLow) {
                         togglePerformanceMode(false); // Call with false to toggle OFF
                    }
                }
                
                alert('Data imported and settings restored successfully!');
            } catch (error) {
                alert('Error processing file. Please ensure it is a valid SME JSON backup.');
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
    }
    
    // =======================================================
    // [G] INITIALIZATION ON LOAD
    // =======================================================
    
    document.addEventListener('DOMContentLoaded', () => {
        const hash = window.location.hash.substring(1) || 'home';
        showPage(hash);
        loadFavorites();
        updateRecentPlayedUI();
        
        // Check local storage for performance mode preference and initialize
        if (localStorage.getItem('performanceMode') === 'low') {
             togglePerformanceMode(true); 
        } else {
             togglePerformanceMode(false);
        }
        
        // Listen for import file selection
        document.getElementById('import-file').addEventListener('change', (event) => {
            importDataFromFile(event);
        });
        
        loadUserProfileData();
    });

</script>

</body>
</html>
